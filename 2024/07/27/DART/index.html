<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>DART学习 | XHW's Blog</title><meta name="keywords" content="Linux,软件"><meta name="author" content="XHW"><meta name="copyright" content="XHW"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="前言 DART是一款NCAR开发的资料同化系统，可以直接与CESM、WRF等模式结合。同化包括MLS、SABER等卫星资料。这个文章记录一下，使用WACCM+DART中遇到的一些坑。 DART_config 在DART&#x2F;models&#x2F;cam-fv&#x2F;shell_scripts&#x2F;cesm2_1&#x2F;中运行setup_hybrid，这将创建CESM的case。在caseroot下将创建DART_config">
<meta property="og:type" content="article">
<meta property="og:title" content="DART学习">
<meta property="og:url" content="http://example.com/2024/07/27/DART/index.html">
<meta property="og:site_name" content="XHW&#39;s Blog">
<meta property="og:description" content="前言 DART是一款NCAR开发的资料同化系统，可以直接与CESM、WRF等模式结合。同化包括MLS、SABER等卫星资料。这个文章记录一下，使用WACCM+DART中遇到的一些坑。 DART_config 在DART&#x2F;models&#x2F;cam-fv&#x2F;shell_scripts&#x2F;cesm2_1&#x2F;中运行setup_hybrid，这将创建CESM的case。在caseroot下将创建DART_config">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/cover22.png">
<meta property="article:published_time" content="2024-07-27T06:43:02.000Z">
<meta property="article:modified_time" content="2024-08-28T06:11:03.489Z">
<meta property="article:author" content="XHW">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="软件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cover22.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/07/27/DART/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'DART学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-28 14:11:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/maomi.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/03/21/CESM/"><i class="fa-fw fas fa-heart"></i><span> CESM</span></a></li><li><a class="site-page child" href="/2022/07/11/linux/"><i class="fa-fw fas fa-heart"></i><span> Linux</span></a></li><li><a class="site-page child" href="/2024/04/24/computeNode/"><i class="fa-fw fas fa-heart"></i><span> vscode计算节点</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover22.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">XHW's Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-heart"></i><span> Article</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/2024/03/21/CESM/"><i class="fa-fw fas fa-heart"></i><span> CESM</span></a></li><li><a class="site-page child" href="/2022/07/11/linux/"><i class="fa-fw fas fa-heart"></i><span> Linux</span></a></li><li><a class="site-page child" href="/2024/04/24/computeNode/"><i class="fa-fw fas fa-heart"></i><span> vscode计算节点</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> gallery</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">DART学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-07-27T06:43:02.000Z" title="Created 2024-07-27 14:43:02">2024-07-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-08-28T06:11:03.489Z" title="Updated 2024-08-28 14:11:03">2024-08-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/">经验总结</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="DART学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言-2">前言</h2>
<p>DART是一款NCAR开发的资料同化系统，可以直接与CESM、WRF等模式结合。同化包括MLS、SABER等卫星资料。这个文章记录一下，使用WACCM+DART中遇到的一些坑。</p>
<h2 id="DART-config">DART_config</h2>
<p>在<code>DART/models/cam-fv/shell_scripts/cesm2_1/</code>中运行<code>setup_hybrid</code>，这将创建CESM的case。在caseroot下将创建<code>DART_config</code>， 他相当于是DART的激活器。 运行DART_config才能在运行case中实现同化，否则就是普通的CESM的case运行。</p>
<p>然而自动生成DART_config有个小bug</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (-f $&#123;DART_SCRIPTS_DIR&#125;/compress.csh) then</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">COPY -f -<span class="variable">$&#123;VERBOSE&#125;</span> <span class="variable">$&#123;DART_SCRIPTS_DIR&#125;</span>/compress.csh . || <span class="built_in">exit</span> 43</span></span><br><span class="line">else</span><br><span class="line">   echo &quot;ERROR: no compress.csh in  $&#123;DART_SCRIPTS_DIR&#125;&quot;</span><br><span class="line">   exit 45</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>这里应当删除<code>$&#123;VERBOSE&#125;</code>前的短横线，改为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (-f $&#123;DART_SCRIPTS_DIR&#125;/compress.csh) then</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">COPY -f <span class="variable">$&#123;VERBOSE&#125;</span> <span class="variable">$&#123;DART_SCRIPTS_DIR&#125;</span>/compress.csh . || <span class="built_in">exit</span> 43</span></span><br><span class="line">else</span><br><span class="line">   echo &quot;ERROR: no compress.csh in  $&#123;DART_SCRIPTS_DIR&#125;&quot;</span><br><span class="line">   exit 45</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x DART_config</span><br><span class="line">./DART_config</span><br></pre></td></tr></table></figure>
<h2 id="input-nml">input.nml</h2>
<p>运行<code>DART_config</code> 后会在caseroot下生成<code>input.nml</code> 这和<code>atm_in</code>类似，但它是用来控制DART的namelist文件。</p>
<p>此时DART已经被激活了, 用 <code>./xmlquery -p ASSIMI</code> 可查看到相关信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DATA_ASSIMILATION: [&#x27;CPL:FALSE&#x27;, &#x27;ATM:TRUE&#x27;, &#x27;LND:FALSE&#x27;, &#x27;ICE:FALSE&#x27;, &#x27;OCN:FALSE&#x27;, &#x27;ROF:FALSE&#x27;, &#x27;GLC:FALSE&#x27;, &#x27;WAV:FALSE&#x27;]</span><br><span class="line">DATA_ASSIMILATION_CYCLES: 1</span><br><span class="line">DATA_ASSIMILATION_SCRIPT: /public/home/elzd_2024_000125/CESM/cases/DART/SSW2013/FWSD.2013.70Lev.DART/no_assimilate.csh</span><br></pre></td></tr></table></figure>
<p>以上信息表明，只有大气分量将被同化， 且只同化一次就停止运行（默认每运行6小时同化一次）。最后一条<code>DATA_ASSIMILATION_SCRIPT=no_assimilation.csh</code> 表明这里使用的是无同化脚本<code>no_assimilation.csh</code> 。这是一个测试用脚本，这个时候运行case，同样不会用同化。 需要</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./xmlchange DATA_ASSIMILATION_SCRIPT=&quot;assimilation.csh&quot;</span><br></pre></td></tr></table></figure>
<p>切换成使用<code>assimilation.csh</code>，这才是真正的同化脚本。</p>
<p>说回input.nml</p>
<p>有几点需要修改</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">! This namelist is set up for a single, CAM-FV, assimilation cycle</span></span><br><span class="line"><span class="comment">! using the default values as found in model_mod.f90 and</span></span><br><span class="line"><span class="comment">! shell_scripts/cesm2_1/setup_&#123;hybrid,advanced&#125;</span></span><br><span class="line"><span class="comment">! starting from a single model state, which must be perturbed into an ensemble.</span></span><br><span class="line"><span class="comment">! Comments below give suggestions for setting it up for other assimilations:</span></span><br><span class="line"><span class="comment">! &gt; continuing an assimilation (no perturbations) and/or starting from an ensemble.</span></span><br><span class="line"><span class="comment">! &gt; Setting up a WACCM(-X) assimilation</span></span><br><span class="line"><span class="comment">! &gt; Setting up for perfect_model_obs</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! PLEASE READ</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! cam-fv/model_mod.html</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! for recommendations on namelist settings for CAM.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! ens_size, num_output_*  will be (re)set by the setup script</span></span><br><span class="line"><span class="comment">! To use a pre-existing ensemble, make the following changes</span></span><br><span class="line"><span class="comment">! This applies to the second cycle after starting from a single ensemble member.</span></span><br><span class="line"><span class="comment">! It&#x27;s not necessary to change any other variables controlling the perturbation</span></span><br><span class="line"><span class="comment">! because this will cause them to be ignored.</span></span><br><span class="line"><span class="comment">!    perturb_from_single_instance = .false.</span></span><br><span class="line"><span class="comment">! Other variables of interest</span></span><br><span class="line"><span class="comment">! stages_to_write          Controls diagnostic and restart output.  Valid values are</span></span><br><span class="line"><span class="comment">!                          &#x27;input&#x27;, &#x27;forecast&#x27;,&#x27;preassim&#x27;, &#x27;postassim&#x27;, &#x27;analysis&#x27;, and &#x27;output&#x27;.</span></span><br><span class="line"><span class="comment">!                          If only prior inflation is used, then &#x27;postassim&#x27; and &#x27;analysis&#x27;</span></span><br><span class="line"><span class="comment">!                          are redundant with &#x27;output&#x27;.  Just use &#x27;output&#x27;.</span></span><br><span class="line"><span class="comment">!                          If only posterior inflation is used, &#x27;forecast&#x27; and &#x27;preassim&#x27;</span></span><br><span class="line"><span class="comment">!                          are redundant with &#x27;input&#x27;.</span></span><br><span class="line"><span class="comment">!                          If you want input_mean and input_sd, you&#x27;ll</span></span><br><span class="line"><span class="comment">!                          need to set output_mean and output_sd = .true.</span></span><br><span class="line"><span class="comment">!                          (and include &#x27;input&#x27; in stages_to_write).</span></span><br><span class="line"><span class="comment">!    inf_initial_from_restart These should be true because assimilate.csh will create</span></span><br><span class="line"><span class="comment">!    inf_sd_from_restart      inflation restart files from the values in inf*_initial</span></span><br><span class="line"><span class="comment">!                             if needed.</span></span><br><span class="line"></span><br><span class="line">&amp;probit_transform_nml</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line">&amp;algorithm_info_nml</span><br><span class="line">   qceff_table_filename = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line">&amp;filter_nml</span><br><span class="line">   input_state_file_list        = <span class="string">&#x27;cam_init_files&#x27;</span></span><br><span class="line">   input_state_files            = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   single_file_in               = .false.</span><br><span class="line">   perturb_from_single_instance = .false.</span><br><span class="line">   init_time_days               = -<span class="number">1</span></span><br><span class="line">   init_time_seconds            = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! 此处修改为&#x27;out&#x27;</span></span><br><span class="line">   stages_to_write              = <span class="string">&#x27;output&#x27;</span></span><br><span class="line"></span><br><span class="line">   output_state_files           = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   output_state_file_list       = <span class="string">&#x27;cam_init_files&#x27;</span></span><br><span class="line">   output_mean                  = .true.</span><br><span class="line">   output_sd                    = .true.</span><br><span class="line">   output_members               = .true.</span><br><span class="line"></span><br><span class="line"><span class="comment">! 和成员数相同</span></span><br><span class="line">   num_output_state_members     = <span class="number">5</span></span><br><span class="line">   </span><br><span class="line">   single_file_out              = .false.</span><br><span class="line">   write_all_stages_at_end      = .false.</span><br><span class="line">   output_interval              = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! 和成员数相同</span></span><br><span class="line">   ens_size                     = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">   num_groups                   = <span class="number">1</span></span><br><span class="line">   distributed_state            = .true.</span><br><span class="line"></span><br><span class="line"><span class="comment">! 设为2或5，详情见官方文档</span></span><br><span class="line">   inf_flavor                  = <span class="number">2</span>,                       <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! 设为.true.    .false， 第一列表示prior，第二列表示posterior</span></span><br><span class="line">   inf_initial_from_restart    = .true.,                  .false.</span><br><span class="line"></span><br><span class="line"><span class="comment">! 主要改第一列，适当比1大，是inflation的系数</span></span><br><span class="line">   inf_initial                 = <span class="number">1.2</span>,                     <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! flation的上下限</span></span><br><span class="line">   inf_lower_bound             = <span class="number">1.02</span>,                     <span class="number">0.0</span></span><br><span class="line">   inf_upper_bound             = <span class="number">100.0</span>,                   <span class="number">100.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! 修改以下，详情见官方文档</span></span><br><span class="line">   inf_sd_initial_from_restart = .true.,                  .false.</span><br><span class="line">   inf_sd_initial              = <span class="number">0.6</span>,                     <span class="number">0.6</span></span><br><span class="line">   inf_sd_lower_bound          = <span class="number">0.6</span>,                     <span class="number">0.6</span></span><br><span class="line">   inf_sd_max_change           = <span class="number">1.05</span>,                    <span class="number">1.05</span></span><br><span class="line">   inf_damping                 = <span class="number">0.9</span>,                     <span class="number">0.0</span></span><br><span class="line">   inf_deterministic           = .true.,                  .true.</span><br><span class="line"></span><br><span class="line">   obs_sequence_in_name     = <span class="string">&#x27;obs_seq.out&#x27;</span></span><br><span class="line">   obs_sequence_out_name    = <span class="string">&#x27;obs_seq.final&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! 和成员数相同</span></span><br><span class="line">   num_output_obs_members   = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">   compute_posterior        = .true.</span><br><span class="line"></span><br><span class="line">   trace_execution          = .true.</span><br><span class="line">   output_timestamps        = .true.</span><br><span class="line">   output_forward_op_errors = .false.</span><br><span class="line">   silence                  = .false.</span><br><span class="line">   /</span><br><span class="line"><span class="comment">! Moha&#x27;s enhanced (gamma distribution) adaptive:</span></span><br><span class="line"><span class="comment">!    inf_flavor                  = 5,                       0</span></span><br><span class="line"><span class="comment">!    inf_lower_bound             = 0.0,                     0.0</span></span><br><span class="line"><span class="comment">! flavor 2</span></span><br><span class="line"><span class="comment">!    inf_flavor                  = 2,                       0</span></span><br><span class="line"><span class="comment">!    inf_lower_bound             = 1.0,                     1.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">! Not used in CAM assims</span></span><br><span class="line">   first_obs_days           = -<span class="number">1</span></span><br><span class="line">   first_obs_seconds        = -<span class="number">1</span></span><br><span class="line">   last_obs_days            = -<span class="number">1</span></span><br><span class="line">   last_obs_seconds         = -<span class="number">1</span></span><br><span class="line">   obs_window_days          = -<span class="number">1</span></span><br><span class="line">   obs_window_seconds       = -<span class="number">1</span></span><br><span class="line">   adv_ens_command          = <span class="string">&#x27;no_CESM_advance_script&#x27;</span></span><br><span class="line">   tasks_per_model_advance      = -<span class="number">1</span>  Used <span class="keyword">only</span> for models run inside filter.</span><br><span class="line">   write_obs_every_cycle        = .false. intended for debugging when cycling inside filter.</span><br><span class="line"></span><br><span class="line">&amp;perfect_model_obs_nml</span><br><span class="line">   read_input_state_from_file = .true.</span><br><span class="line">   input_state_files          = <span class="string">&quot;caminput.nc&quot;</span></span><br><span class="line">   init_time_days             = -<span class="number">1</span></span><br><span class="line">   init_time_seconds          = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">   write_output_state_to_file = .true.</span><br><span class="line">   output_state_files         = <span class="string">&quot;perfect_restart.nc&quot;</span></span><br><span class="line"></span><br><span class="line">   obs_seq_in_file_name       = <span class="string">&quot;obs_seq.in&quot;</span></span><br><span class="line">   obs_seq_out_file_name      = <span class="string">&quot;obs_seq.out&quot;</span></span><br><span class="line">   first_obs_days             = -<span class="number">1</span></span><br><span class="line">   first_obs_seconds          = -<span class="number">1</span></span><br><span class="line">   last_obs_days              = -<span class="number">1</span></span><br><span class="line">   last_obs_seconds           = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">   trace_execution            = .true.</span><br><span class="line">   output_timestamps          = .true.</span><br><span class="line">   print_every_nth_obs        = <span class="number">0</span></span><br><span class="line">   output_forward_op_errors   = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line">#========================================================================</span><br><span class="line"># Start of CAM-FV dependencies and general discussion.</span><br><span class="line">#========================================================================</span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! Creation of initial ensemble from a single model state.</span></span><br><span class="line"><span class="comment">!     fields_to_perturb lists the DART QTY_s of the state variables to be perturbed to make the ensemble.</span></span><br><span class="line"><span class="comment">!     perturbation_amplitude &gt; 0 allows each point of the fields_to_perturb fields of each ens member </span></span><br><span class="line"><span class="comment">!         to be randomly perturbed with a standard deviation of perturbation_amplitude.  </span></span><br><span class="line"><span class="comment">!         Each field can be given a different perturbation_amplitude.</span></span><br><span class="line"><span class="comment">!     Used by filter&#x27;s call to pert_model_copies.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! state_variables (5 columns for each variable):</span></span><br><span class="line"><span class="comment">!     netcdf varname, dart quantity, min allowed value, max allowed value, (no)update this var</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! vert_normalization_YYY</span></span><br><span class="line"><span class="comment">!     The vert_normalization_scale_height default value was chosen based on </span></span><br><span class="line"><span class="comment">!     Pedatella&#x27;s settling on 1.5 (scale heights/radian), based on tuning experiments.</span></span><br><span class="line"><span class="comment">!     This is supported by tuning experiments with CAM5.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! use_log_vertical_scale(vertical interpolation only):</span></span><br><span class="line"><span class="comment">!     .false. or .true.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! no_obs_assim_above_level </span></span><br><span class="line"><span class="comment">!     Prevents assimilation of observations whose vertical location is above</span></span><br><span class="line"><span class="comment">!     this model level.  Note that, if this value is set to a large value,</span></span><br><span class="line"><span class="comment">!     it may be within CAM&#x27;s hybrid coordinate layers instead of in the pure pressure layers.</span></span><br><span class="line"><span class="comment">!     This will result in the the observation cutoff height being at different pressure levels</span></span><br><span class="line"><span class="comment">!     over mountains versus lower areas.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! model_damping_ends_at_level</span></span><br><span class="line"><span class="comment">!     This controls how much innovations are reduced near the model top, to mitigate the effects </span></span><br><span class="line"><span class="comment">!     of the extra diffusion sometimes applied there in CAM and WACCM (see fv_div24del2flag).</span></span><br><span class="line"><span class="comment">!     The default value (-1) turns off the damping and relies on the choices of the following </span></span><br><span class="line"><span class="comment">!     variables to prevent assimilation from happening in CAM&#x27;s diffusive top layers:</span></span><br><span class="line"><span class="comment">!        no_obs_assim_above_level,</span></span><br><span class="line"><span class="comment">!        use_log_vertical_scale,</span></span><br><span class="line"><span class="comment">!        vert_normalization_YYY,</span></span><br><span class="line"><span class="comment">!        cutoff.</span></span><br><span class="line"><span class="comment">!     When it is turned on (&gt; 0), it is the lowest level which will be damped.  </span></span><br><span class="line"><span class="comment">!     Damping increases with height (smaller level numbers).</span></span><br><span class="line"><span class="comment">!     The values given below are the minimums recommended for various models.</span></span><br><span class="line"><span class="comment">!     You can start with the minimum and increase it if there seems to be excessive</span></span><br><span class="line"><span class="comment">!     noise in the upper layers.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! CAM-FV Section</span></span><br><span class="line"><span class="comment">!     Model top 220 Pa</span></span><br><span class="line"><span class="comment">!     Number of CAM model top levels with extra diffusion, controlled by div24del2:</span></span><br><span class="line"><span class="comment">!         2 = div2    -&gt; 2 levels</span></span><br><span class="line"><span class="comment">!         4,24 = del2 -&gt; 3 levels </span></span><br><span class="line"><span class="comment">!     CAM assimilations can use pressure or scale height vertical coordinate.</span></span><br><span class="line"><span class="comment">!     We recommend scale height.</span></span><br><span class="line"><span class="comment">!        use_log_vertical_scale          = .true.</span></span><br><span class="line"><span class="comment">!        vert_normalization_scale_height = 1.5 </span></span><br><span class="line"><span class="comment">!        vert_normalization_pressure     = 20000. </span></span><br><span class="line"><span class="comment">!     </span></span><br><span class="line"><span class="comment">!     26 levels (CAM4):</span></span><br><span class="line"><span class="comment">!        no_obs_assim_above_level            = 5       ! corresponds to ~3700 Pa</span></span><br><span class="line"><span class="comment">!     30 levels (CAM5):</span></span><br><span class="line"><span class="comment">!        no_obs_assim_above_level            = 5       ! corresponds to ~3800 Pa</span></span><br><span class="line"><span class="comment">!     32 levels (CAM6):</span></span><br><span class="line"><span class="comment">!        no_obs_assim_above_level            = 5       ! corresponds to ~3600 Pa</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! WACCM </span></span><br><span class="line"><span class="comment">!     The model top for WACCM is (naturally) much higher: 4.5e-4 Pa</span></span><br><span class="line"><span class="comment">!     The number of model top levels with extra diffusion is controlled by WACCM&#x27;s </span></span><br><span class="line"><span class="comment">!     fv_div24del2flag:</span></span><br><span class="line"><span class="comment">!         2 = div2    -&gt; 3 levels</span></span><br><span class="line"><span class="comment">!         4,24 = del2 -&gt; 4 levels</span></span><br><span class="line"><span class="comment">!     70 levels (WACCM4):</span></span><br><span class="line"><span class="comment">!        no_obs_assim_above_level            = 7       ! corresponds to 0.012 Pa</span></span><br><span class="line"><span class="comment">!     This values must be used with WACCM assimilations;</span></span><br><span class="line"><span class="comment">!        use_log_vertical_scale          = .true.</span></span><br><span class="line"><span class="comment">!     This is recommended, but your own tuning experiments may support a different value.</span></span><br><span class="line"><span class="comment">!        vert_normalization_scale_height = 1.5</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">!========================================================================</span></span><br><span class="line"></span><br><span class="line">&amp;model_nml</span><br><span class="line">   <span class="comment">!cam_template_filename       = &#x27;caminput.nc&#x27;</span></span><br><span class="line">   cam_template_filename       = <span class="string">&#x27;caminput.nc&#x27;</span></span><br><span class="line">   cam_phis_filename           = <span class="string">&#x27;cam_phis.nc&#x27;</span></span><br><span class="line">   custom_routine_to_generate_ensemble = .false.</span><br><span class="line"></span><br><span class="line"><span class="comment">! 不做扰动，因为没有用dart自己添加扰动成功过。 自己手动加好扰动</span></span><br><span class="line">   fields_to_perturb                   = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   perturbation_amplitude              = <span class="number">0.1</span></span><br><span class="line">   state_variables  = <span class="string">&#x27;T&#x27;</span>,     <span class="string">&#x27;QTY_TEMPERATURE&#x27;</span>,         <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;US&#x27;</span>,    <span class="string">&#x27;QTY_U_WIND_COMPONENT&#x27;</span>,    <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;VS&#x27;</span>,    <span class="string">&#x27;QTY_V_WIND_COMPONENT&#x27;</span>,    <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;Q&#x27;</span>,     <span class="string">&#x27;QTY_SPECIFIC_HUMIDITY&#x27;</span>,   <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;CLDLIQ&#x27;</span>,<span class="string">&#x27;QTY_CLOUD_LIQUID_WATER&#x27;</span>,  <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;CLDICE&#x27;</span>,<span class="string">&#x27;QTY_CLOUD_ICE&#x27;</span>,           <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">                      <span class="string">&#x27;PS&#x27;</span>,    <span class="string">&#x27;QTY_SURFACE_PRESSURE&#x27;</span>,    <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;NA&#x27;</span>, <span class="string">&#x27;UPDATE&#x27;</span></span><br><span class="line">   use_log_vertical_scale              = .true.</span><br><span class="line"></span><br><span class="line"><span class="comment">! 设为.true.</span></span><br><span class="line">   use_variable_mean_mass              = .true.</span><br><span class="line">   no_normalization_of_scale_heights   = .true.</span><br><span class="line">   vertical_localization_coord         = <span class="string">&#x27;SCALEHEIGHT&#x27;</span></span><br><span class="line">   no_obs_assim_above_level            = <span class="number">5</span></span><br><span class="line">   model_damping_ends_at_level         = -<span class="number">1</span></span><br><span class="line">   using_chemistry                = .false.</span><br><span class="line">   assimilation_period_days       = <span class="number">0</span></span><br><span class="line">   assimilation_period_seconds    = <span class="number">21600</span></span><br><span class="line">   suppress_grid_info_in_output   = .false.</span><br><span class="line">   debug_level                    = <span class="number">0</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"><span class="comment">! Other fields in the CAM initial file, which could be included in the model state:</span></span><br><span class="line"><span class="comment">! These QTYs should be changed to physically meaningful values before any real assim.</span></span><br><span class="line"><span class="comment">!                       &#x27;DMS&#x27;,   &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;H2O2&#x27;,  &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;H2SO4&#x27;, &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;NUMICE&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;NUMLIQ&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;NUMRAI&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;NUMSNO&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;RAINQM&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;SNOWQM&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;SO2&#x27;,   &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;SOAG&#x27;,  &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;bc_a1&#x27;, &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;bc_a4&#x27;, &#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;dst_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;dst_a2&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;dst_a3&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;ncl_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;ncl_a2&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;ncl_a3&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;num_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;num_a2&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;num_a3&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;num_a4&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;pom_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;pom_a4&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;so4_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;so4_a2&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;so4_a3&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;soa_a1&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line"><span class="comment">!                       &#x27;soa_a2&#x27;,&#x27;QTY_3D_PARAMETER&#x27;,    &#x27;NA&#x27;, &#x27;NA&#x27;, &#x27;UPDATE&#x27;</span></span><br><span class="line">&amp;location_nml</span><br><span class="line">   horiz_dist_only                 = .false.</span><br><span class="line">   vert_normalization_pressure     = <span class="number">20000.0</span></span><br><span class="line">   vert_normalization_height       = <span class="number">10000.0</span></span><br><span class="line">   vert_normalization_level        = <span class="number">20.0</span></span><br><span class="line">   vert_normalization_scale_height = <span class="number">1.5</span></span><br><span class="line">   approximate_distance            = .true.</span><br><span class="line">   nlon                            = <span class="number">141</span></span><br><span class="line">   nlat                            = <span class="number">72</span></span><br><span class="line">   output_box_info                 = .false.</span><br><span class="line">   print_box_level                 = <span class="number">0</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line">#========================================================================</span><br><span class="line"># <span class="keyword">End</span> of CAM-FV dependencies.</span><br><span class="line">#========================================================================</span><br><span class="line"></span><br><span class="line">&amp;fill_inflation_restart_nml</span><br><span class="line">   write_prior_inf = .true.</span><br><span class="line"></span><br><span class="line"><span class="comment">! inflation系数，适当地比1大</span></span><br><span class="line">   prior_inf_mean  = <span class="number">1.2</span></span><br><span class="line">   prior_inf_sd    = <span class="number">0.6</span></span><br><span class="line"></span><br><span class="line">   write_post_inf  = .false.</span><br><span class="line">   post_inf_mean   = <span class="number">1.00</span></span><br><span class="line">   post_inf_sd     = <span class="number">0.6</span></span><br><span class="line"></span><br><span class="line">   input_state_files = <span class="string">&#x27;caminput.nc&#x27;</span></span><br><span class="line">   single_file       = .false.</span><br><span class="line">                       </span><br><span class="line">   verbose           = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"><span class="comment">! to use chemistry or saber temperatures, include the following below.</span></span><br><span class="line"><span class="comment">!                             &#x27;../../../observations/forward_operators/obs_def_CO_Nadir_mod.f90&#x27;,</span></span><br><span class="line"><span class="comment">!                             &#x27;../../../observations/forward_operators/obs_def_SABER_mod.f90&#x27;,</span></span><br><span class="line"><span class="comment">!                             &#x27;../../../observations/forward_operators/obs_def_MOPITT_CO_mod.f90&#x27;,</span></span><br><span class="line"></span><br><span class="line">&amp;preprocess_nml</span><br><span class="line">   overwrite_output        = .true.</span><br><span class="line">   input_obs_qty_mod_file  = <span class="string">&#x27;../../../assimilation_code/modules/observations/DEFAULT_obs_kind_mod.F90&#x27;</span></span><br><span class="line">   output_obs_qty_mod_file = <span class="string">&#x27;../../../assimilation_code/modules/observations/obs_kind_mod.f90&#x27;</span></span><br><span class="line">   input_obs_def_mod_file  = <span class="string">&#x27;../../../observations/forward_operators/DEFAULT_obs_def_mod.F90&#x27;</span></span><br><span class="line">   output_obs_def_mod_file = <span class="string">&#x27;../../../observations/forward_operators/obs_def_mod.f90&#x27;</span></span><br><span class="line">   obs_type_files          = <span class="string">&#x27;../../../observations/forward_operators/obs_def_gps_mod.f90&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;../../../observations/forward_operators/obs_def_upper_atm_mod.f90&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;../../../observations/forward_operators/obs_def_reanalysis_bufr_mod.f90&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;../../../observations/forward_operators/obs_def_altimeter_mod.f90&#x27;</span></span><br><span class="line">   quantity_files          = <span class="string">&#x27;../../../assimilation_code/modules/observations/atmosphere_quantities_mod.f90&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;../../../assimilation_code/modules/observations/space_quantities_mod.f90&#x27;</span>,</span><br><span class="line">                             <span class="string">&#x27;../../../assimilation_code/modules/observations/chemistry_quantities_mod.f90&#x27;</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"><span class="comment">! Not usually assimilated.  No fundamental reason not to.</span></span><br><span class="line"><span class="comment">!                               &#x27;RADIOSONDE_SPECIFIC_HUMIDITY&#x27;,</span></span><br><span class="line"><span class="comment">! Available from mid-2006 onward.  Build filter with obs_def_gps_mod.f90</span></span><br><span class="line"><span class="comment">!                               &#x27;GPSRO_REFRACTIVITY&#x27;,</span></span><br><span class="line"><span class="comment">! WACCM can use higher observations than CAM.</span></span><br><span class="line"><span class="comment">! An example can be included via obs_def_SABER_mod.f90.</span></span><br><span class="line"><span class="comment">!                               &#x27;SABER_TEMPERATURE&#x27;,</span></span><br><span class="line"></span><br><span class="line">&amp;obs_kind_nml</span><br><span class="line">   assimilate_these_obs_types = <span class="string">&#x27;AURAMLS_TEMPERATURE&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">!   assimilate_these_obs_types = &#x27;RADIOSONDE_U_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;RADIOSONDE_V_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;RADIOSONDE_TEMPERATURE&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;AIRCRAFT_U_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;AIRCRAFT_V_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;AIRCRAFT_TEMPERATURE&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;ACARS_U_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;ACARS_V_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;ACARS_TEMPERATURE&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;SAT_U_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;SAT_V_WIND_COMPONENT&#x27;,</span></span><br><span class="line"><span class="comment">!                                &#x27;GPSRO_REFRACTIVITY&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">!   evaluate_these_obs_types = &#x27;RADIOSONDE_SPECIFIC_HUMIDITY&#x27;,</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;state_vector_io_nml</span><br><span class="line">   buffer_state_io         = .false.</span><br><span class="line">   single_precision_output = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">! &#x27;layout&#x27; and &#x27;tasks_per_node&#x27; will be reset by the assimilate.csh script</span></span><br><span class="line"><span class="comment">! to match the number used when laying out the job.</span></span><br><span class="line"></span><br><span class="line">&amp;ensemble_manager_nml</span><br><span class="line">   layout         = <span class="number">2</span></span><br><span class="line">   tasks_per_node = <span class="number">16</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;assim_tools_nml</span><br><span class="line">   cutoff                            = <span class="number">0.15</span></span><br><span class="line">   sort_obs_inc                      = .false.</span><br><span class="line">   spread_restoration                = .false.</span><br><span class="line">   sampling_error_correction       = .true.</span><br><span class="line">   adaptive_localization_threshold   = -<span class="number">1</span></span><br><span class="line">   output_localization_diagnostics   = .false.</span><br><span class="line">   localization_diagnostics_file     = <span class="string">&#x27;localization_diagnostics&#x27;</span></span><br><span class="line">   convert_all_obs_verticals_first   = .true.</span><br><span class="line">   convert_all_state_verticals_first = .true.</span><br><span class="line">   print_every_nth_obs               = <span class="number">10000</span></span><br><span class="line">   distribute_mean                   = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;cov_cutoff_nml</span><br><span class="line">   select_localization = <span class="number">1</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;reg_factor_nml</span><br><span class="line">   select_regression    = <span class="number">1</span></span><br><span class="line">   input_reg_file       = <span class="string">&#x27;time_mean_reg&#x27;</span></span><br><span class="line">   save_reg_diagnostics = .false.</span><br><span class="line">   reg_diagnostics_file = <span class="string">&#x27;reg_diagnostics&#x27;</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_sequence_nml</span><br><span class="line">   write_binary_obs_sequence = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;quality_control_nml</span><br><span class="line">   input_qc_threshold          =  <span class="number">3.0</span></span><br><span class="line">   outlier_threshold           =  <span class="number">3.0</span></span><br><span class="line">   enable_special_outlier_code = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;xyz_location_nml</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">!  : error codes &gt;= TERMLEVEL will cause termination</span></span><br><span class="line"><span class="comment">!  E_DBG = -2,   E_MSG = -1,  E_ALLMSG = 0, E_WARN = 1, E_ERR = 2</span></span><br><span class="line"><span class="comment">!  write_nml default is &#x27;file&#x27;.</span></span><br><span class="line"><span class="comment">!    write_nml = &#x27;none&#x27;  reduces printed output.</span></span><br><span class="line">&amp;utilities_nml</span><br><span class="line">   TERMLEVEL      = <span class="number">2</span></span><br><span class="line">   module_details = .false.</span><br><span class="line">   logfilename    = <span class="string">&#x27;dart_log.out&#x27;</span></span><br><span class="line">   nmlfilename    = <span class="string">&#x27;dart_log.nml&#x27;</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;mpi_utilities_nml</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_def_gps_nml</span><br><span class="line">   max_gpsro_obs = <span class="number">15000000</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#========================================================================</span><br><span class="line"># observation manipulation tools</span><br><span class="line">#========================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment">! other possible obs tool namelist items:</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! keep only the U and V radiosonde winds:</span></span><br><span class="line"><span class="comment">!   obs_types          = &#x27;RADIOSONDE_U_WIND_COMPONENT&#x27;</span></span><br><span class="line"><span class="comment">!                        &#x27;RADIOSONDE_V_WIND_COMPONENT&#x27;</span></span><br><span class="line"><span class="comment">!   keep_types         = .true.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! remove the U and V radiosonde winds:</span></span><br><span class="line"><span class="comment">!   obs_types          = &#x27;RADIOSONDE_U_WIND_COMPONENT&#x27;</span></span><br><span class="line"><span class="comment">!                        &#x27;RADIOSONDE_V_WIND_COMPONENT&#x27;</span></span><br><span class="line"><span class="comment">!   keep_types         = .false.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! keep only observations with a DART QC of 0:</span></span><br><span class="line"><span class="comment">!   qc_metadata        = &#x27;Dart quality control&#x27;</span></span><br><span class="line"><span class="comment">!   min_qc             = 0</span></span><br><span class="line"><span class="comment">!   max_qc             = 0</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! keep only radiosonde temp obs between 250 and 300 K:</span></span><br><span class="line"><span class="comment">!   copy_metadata      = &#x27;NCEP BUFR observation&#x27;</span></span><br><span class="line"><span class="comment">!   copy_type          = &#x27;RADIOSONDE_TEMPERATURE&#x27;</span></span><br><span class="line"><span class="comment">!   min_copy           = 250.0</span></span><br><span class="line"><span class="comment">!   max_copy           = 300.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_sequence_tool_nml</span><br><span class="line">   num_input_files    = <span class="number">2</span></span><br><span class="line">   filename_seq       = <span class="string">&#x27;obs_seq.one&#x27;</span>, <span class="string">&#x27;obs_seq.two&#x27;</span></span><br><span class="line">   filename_out       = <span class="string">&#x27;obs_seq.processed&#x27;</span></span><br><span class="line">   first_obs_days     = -<span class="number">1</span></span><br><span class="line">   first_obs_seconds  = -<span class="number">1</span></span><br><span class="line">   last_obs_days      = -<span class="number">1</span></span><br><span class="line">   last_obs_seconds   = -<span class="number">1</span></span><br><span class="line">   min_lat            =  -<span class="number">90.0</span></span><br><span class="line">   max_lat            =   <span class="number">90.0</span></span><br><span class="line">   min_lon            =    <span class="number">0.0</span></span><br><span class="line">   max_lon            =  <span class="number">360.0</span></span><br><span class="line">   gregorian_cal      = .true.</span><br><span class="line">   print_only         =  .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_common_subset_nml</span><br><span class="line">   num_to_compare_at_once   = <span class="number">2</span></span><br><span class="line">   filename_seq             = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   filename_seq_list        = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   filename_out_suffix      = <span class="string">&#x27;.common&#x27;</span> </span><br><span class="line">   print_only               = .false.</span><br><span class="line">   print_every              = <span class="number">10000</span></span><br><span class="line">   calendar                 = <span class="string">&#x27;Gregorian&#x27;</span></span><br><span class="line">   dart_qc_threshold        = <span class="number">3</span></span><br><span class="line">   eval_and_assim_can_match = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_impact_tool_nml</span><br><span class="line">   input_filename         = <span class="string">&#x27;cross_correlations.txt&#x27;</span></span><br><span class="line">   output_filename        = <span class="string">&#x27;control_impact_runtime.txt&#x27;</span></span><br><span class="line">   debug                  = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#========================================================================</span><br><span class="line"># diagnostic tools</span><br><span class="line">#========================================================================</span><br><span class="line"></span><br><span class="line"><span class="comment">! The times in the namelist for the obs_diag program are vectors</span></span><br><span class="line"><span class="comment">! that follow the following sequence:</span></span><br><span class="line"><span class="comment">! year   month   day   hour   minute   second</span></span><br><span class="line"><span class="comment">! max_num_bins can be used to specify a fixed number of bins,</span></span><br><span class="line"><span class="comment">! in which case last_bin_center should be safely in the future.</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! Acceptable latitudes range from  [-90,  90]</span></span><br><span class="line"><span class="comment">! Acceptable longitudes range from [  0, Inf]</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! Other available namelist variables, not in the default obs_diag.nml:</span></span><br><span class="line"><span class="comment">!  hlevel</span></span><br><span class="line"><span class="comment">!  mlevel</span></span><br><span class="line"><span class="comment">!  print_obs_locations</span></span><br><span class="line"><span class="comment">!  outliers_in_histogram</span></span><br><span class="line"><span class="comment">!  plevel_edges</span></span><br><span class="line"><span class="comment">!  hlevel_edges</span></span><br><span class="line"><span class="comment">!  mlevel_edges</span></span><br><span class="line"><span class="comment">! Standard layers:</span></span><br><span class="line"><span class="comment">! 1000, 925, 850, 700, 600, 500, 400, 300,  250,  200,  150,  100,   70,   50,   30,   20,   10 hPa</span></span><br><span class="line"><span class="comment">!    +950(MetOffc)     -600(skipped in obs_diag.f90 defaults)   -70 and less skipped in obs_diag.f90</span></span><br><span class="line"><span class="comment">! Corresponding heights (assuming a standard atmosphere)</span></span><br><span class="line"><span class="comment">! 200,  650, 1350, 2900,4100,5480,7090,9080,10280,11700,13520,16100,18358,21060,24640,27480,32330</span></span><br><span class="line"><span class="comment">! I&#x27;ve changed the height vertical axis in plot_rmse_xxx* to be logarithmic </span></span><br><span class="line"><span class="comment">! in order to make the layers look more like the pressure layers.</span></span><br><span class="line"><span class="comment">! So the bottom edge can&#x27;t be 0.</span></span><br><span class="line"><span class="comment">! The lowest GPS ob is 200, so that&#x27;s the new lowest edge</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">!    plevel = 1000.,925.,850.,700.,500.,400.,300.,250.,200.,150.,100.,50.,20.,10.</span></span><br><span class="line"><span class="comment">!    hlevel = 1000., 2000., 3000., 4000., 5000., 6000., 7000., 8000., 9000., 10000.,11000.</span></span><br><span class="line"><span class="comment">!             0, 1500, 2500, 3500, 4500, 5500, 6500, 7500, 9500, 11500, 13500, 15500</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! Defaults</span></span><br><span class="line"><span class="comment">!    plevel = 1000.,850.,700.,500.,400.,300.,200.,150.,100.</span></span><br><span class="line"><span class="comment">!    Nregions   = 4</span></span><br><span class="line"><span class="comment">!    lonlim1    =   0.0,   0.0,   0.0, 235.0</span></span><br><span class="line"><span class="comment">!    lonlim2    = 360.0, 360.0, 360.0, 295.0</span></span><br><span class="line"><span class="comment">!    latlim1    =  20.0, -80.0, -20.0,  25.0</span></span><br><span class="line"><span class="comment">!    latlim2    =  80.0, -20.0,  20.0,  55.0</span></span><br><span class="line"><span class="comment">!    reg_names  = &#x27;Northern Hemisphere&#x27;, &#x27;Southern Hemisphere&#x27;, &#x27;Tropics&#x27;, &#x27;North America&#x27;</span></span><br><span class="line"><span class="comment">!</span></span><br><span class="line"><span class="comment">! for WACCM you will want to change the plevel to match</span></span><br><span class="line"><span class="comment">! the higher vertical range of the model.</span></span><br><span class="line"><span class="comment">!   plevel = 1000.,850.,700.,500.,400.,300.,200.,150.,100.</span></span><br><span class="line"><span class="comment">! these are specified in hectopascals (hPa)</span></span><br><span class="line"></span><br><span class="line">&amp;obs_diag_nml</span><br><span class="line">   obs_sequence_name = <span class="string">&#x27;obs_seq.final&#x27;</span></span><br><span class="line">   obs_sequence_list = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   first_bin_center  =  BOGUS_YEAR, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">   last_bin_center   =  BOGUS_YEAR, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">   bin_separation    =     <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">   bin_width         =     <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">   time_to_skip      =     <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">   max_num_bins      = <span class="number">1000</span></span><br><span class="line">   trusted_obs       = <span class="string">&#x27;null&#x27;</span></span><br><span class="line">   plevel_edges = <span class="number">1035.5</span>, <span class="number">962.5</span>, <span class="number">887.5</span>, <span class="number">775</span>, <span class="number">600</span>, <span class="number">450</span>, <span class="number">350</span>, <span class="number">275</span>, <span class="number">225</span>,   <span class="number">175</span>,   <span class="number">125</span>,   <span class="number">75</span>,   <span class="number">35</span>,   <span class="number">15</span>,    <span class="number">2</span></span><br><span class="line">   hlevel_edges =    <span class="number">200</span>, <span class="number">630</span>,   <span class="number">930</span>,  <span class="number">1880</span>,<span class="number">3670</span>,<span class="number">5680</span>,<span class="number">7440</span>,<span class="number">9130</span>,<span class="number">10530</span>,<span class="number">12290</span>, <span class="number">14650</span>,<span class="number">18220</span>,<span class="number">23560</span>,<span class="number">29490</span>,<span class="number">43000</span></span><br><span class="line">   Nregions     = <span class="number">3</span></span><br><span class="line">   reg_names    = <span class="string">&#x27;Northern Hemisphere&#x27;</span>, <span class="string">&#x27;Tropics&#x27;</span>, <span class="string">&#x27;Southern Hemisphere&#x27;</span></span><br><span class="line">   lonlim1      =   <span class="number">0.0</span>,   <span class="number">0.0</span>,   <span class="number">0.0</span></span><br><span class="line">   lonlim2      = <span class="number">360.0</span>, <span class="number">360.0</span>, <span class="number">360.0</span></span><br><span class="line">   latlim1      =  <span class="number">20.0</span>, -<span class="number">20.0</span>, -<span class="number">90.0</span></span><br><span class="line">   latlim2      =  <span class="number">90.0</span>,  <span class="number">20.0</span>, -<span class="number">20.0</span></span><br><span class="line">   print_mismatched_locs = .false.</span><br><span class="line">   create_rank_histogram = .true.</span><br><span class="line">   outliers_in_histogram = .true.</span><br><span class="line">   use_zero_error_obs    = .false.</span><br><span class="line">   verbose               = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;schedule_nml</span><br><span class="line">   calendar             = <span class="string">&#x27;Gregorian&#x27;</span></span><br><span class="line">   first_bin_start      =  <span class="number">1601</span>,  <span class="number">1</span>,  <span class="number">1</span>,  <span class="number">0</span>,  <span class="number">0</span>,  <span class="number">0</span></span><br><span class="line">   first_bin_end        =  <span class="number">2999</span>,  <span class="number">1</span>,  <span class="number">1</span>,  <span class="number">0</span>,  <span class="number">0</span>,  <span class="number">0</span></span><br><span class="line">   last_bin_end         =  <span class="number">2999</span>,  <span class="number">1</span>,  <span class="number">1</span>,  <span class="number">0</span>,  <span class="number">0</span>,  <span class="number">0</span></span><br><span class="line">   bin_interval_days    = <span class="number">1000000</span></span><br><span class="line">   bin_interval_seconds = <span class="number">0</span></span><br><span class="line">   max_num_bins         = <span class="number">1000</span></span><br><span class="line">   print_table          = .true.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;obs_seq_to_netcdf_nml</span><br><span class="line">   obs_sequence_name = <span class="string">&#x27;obs_seq.final&#x27;</span></span><br><span class="line">   obs_sequence_list = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   append_to_netcdf  = .false.</span><br><span class="line">   lonlim1    =    <span class="number">0.0</span></span><br><span class="line">   lonlim2    =  <span class="number">360.0</span></span><br><span class="line">   latlim1    =  -<span class="number">90.0</span></span><br><span class="line">   latlim2    =   <span class="number">90.0</span></span><br><span class="line">   verbose    = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;model_mod_check_nml</span><br><span class="line">   input_state_files     = <span class="string">&#x27;caminput.nc&#x27;</span></span><br><span class="line">   output_state_files    = <span class="string">&#x27;mmc_output.nc&#x27;</span></span><br><span class="line">   test1thru             = <span class="number">0</span></span><br><span class="line">   run_tests             = <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">7</span></span><br><span class="line">   x_ind                 = <span class="number">175001</span></span><br><span class="line"></span><br><span class="line">   quantity_of_interest  = <span class="string">&#x27;QTY_U_WIND_COMPONENT&#x27;</span></span><br><span class="line">   loc_of_interest       = <span class="number">254.727854</span>, <span class="number">39.9768545</span>, <span class="number">50000.0</span></span><br><span class="line"></span><br><span class="line">   interp_test_lonrange  = <span class="number">0.0</span>, <span class="number">360.0</span></span><br><span class="line">   interp_test_dlon      = <span class="number">1.0</span></span><br><span class="line">   interp_test_latrange  = -<span class="number">90.0</span>, <span class="number">90.0</span></span><br><span class="line">   interp_test_dlat      = <span class="number">1.0</span></span><br><span class="line">   interp_test_vertrange = <span class="number">10000.0</span>,  <span class="number">90000.0</span></span><br><span class="line">   interp_test_dvert     = <span class="number">10000.0</span></span><br><span class="line">   interp_test_vertcoord = <span class="string">&#x27;VERTISPRESSURE&#x27;</span></span><br><span class="line">   verbose               = .false.</span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">! different methods to compute &#x27;distance&#x27; from mean:</span></span><br><span class="line"><span class="comment">!  1 = simple absolute difference</span></span><br><span class="line"><span class="comment">!  2 = normalized absolute difference</span></span><br><span class="line"><span class="comment">!  3 = simple rmse difference</span></span><br><span class="line"><span class="comment">!  4 = normalized rmse difference</span></span><br><span class="line"></span><br><span class="line">&amp;closest_member_tool_nml</span><br><span class="line">   input_restart_file_list = <span class="string">&#x27;cam_in.txt&#x27;</span></span><br><span class="line">   output_file_name        = <span class="string">&#x27;closest_restart&#x27;</span></span><br><span class="line"><span class="comment">! 和成员数相同</span></span><br><span class="line">   ens_size                = <span class="number">5</span></span><br><span class="line">   single_restart_file_in  = .false.</span><br><span class="line">   difference_method       = <span class="number">4</span></span><br><span class="line">   use_only_qtys           = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;perturb_single_instance_nml</span><br><span class="line"><span class="comment">! 和成员数相同</span></span><br><span class="line">   ens_size               = <span class="number">5</span></span><br><span class="line">   input_files            = <span class="string">&#x27;caminput.nc&#x27;</span></span><br><span class="line">   output_files           = <span class="string">&#x27;cam_pert1.nc&#x27;</span>,<span class="string">&#x27;cam_pert2.nc&#x27;</span>,<span class="string">&#x27;cam_pert3.nc&#x27;</span></span><br><span class="line">   output_file_list       = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   perturbation_amplitude = <span class="number">0.2</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp;quad_interpolate_nml</span><br><span class="line">   debug = <span class="number">0</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line">&amp;cam_dart_obs_preprocessor_nml</span><br><span class="line">   filename_in  = <span class="string">&#x27;obs_seq.out&#x27;</span></span><br><span class="line">   filename_out = <span class="string">&#x27;obs_seq.nohighobs&#x27;</span></span><br><span class="line">   verbose      = .false.</span><br><span class="line">   calendar     = <span class="string">&#x27;Gregorian&#x27;</span></span><br><span class="line">   print_every  = <span class="number">5000</span></span><br><span class="line">   /</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="assimilation-csh">assimilation.csh</h2>
<p>这是实际执行同化的脚本，有一些内容需要修改</p>
<p>首先在所有程序运行之前添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set nonomatch</span><br></pre></td></tr></table></figure>
<p>可以防止ls, rm 等命令找不到文件时不会报错终止</p>
<p>后来发现太多需要修改的了，以下贴出完整的assimilation.csh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/csh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DART software - Copyright UCAR. This open source software is provided</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">by UCAR, <span class="string">&quot;as is&quot;</span>, without charge, subject to all terms of use at</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://www.image.ucar.edu/DAReS/DART/DART_download</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DART $Id$</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Purpose: assimilate with a CAM ensemble and perform advanced archiving</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         and compression <span class="keyword">in</span> support of multiple assimilation cycles <span class="keyword">in</span> a</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         single CESM job.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The (resulting) assimilate.csh script is called by CESM with two arguments:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1) the CASEROOT, and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2) the assimilation cycle number <span class="keyword">in</span> this CESM job</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This template is lightly modified by the setup scripts to be appropriate</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> specific hardware and other configurations. The modified result is</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">then</span> given execute permission and is appropriate to use <span class="keyword">for</span> an assimilation.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">All of this is automatically performed by the DART-supplied setup scripts.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Tag DART&#x27;s state output with names using CESM&#x27;s convention:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="variable">$&#123;case&#125;</span>.<span class="variable">$&#123;scomp&#125;</span>[_<span class="variable">$inst</span>].<span class="variable">$&#123;filetype&#125;</span>[.<span class="variable">$dart_file</span>].<span class="variable">$&#123;date&#125;</span>.nc</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   These should all be named with <span class="variable">$scomp</span> = <span class="string">&quot;cam&quot;</span> to distinguish</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   them from the same output from other components <span class="keyword">in</span> multi-component assims.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># This script also has logic in it to manage disk space in a way that allows</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> more assimilation cycles to be performed before archiving without losing</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">critical restart capability. The same logic is also useful <span class="keyword">for</span> assimilations</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that may require multiple timesteps to be available.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># As a specific example, consider the case when 3 assimilation cycles have been</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">performed: 6Z, 12Z, 18Z.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If we want to keep a restart <span class="built_in">set</span> and a backup</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">restart <span class="built_in">set</span>, we only need the 18Z and 12Z, so the 6Z <span class="built_in">set</span> can be removed.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Let<span class="string">&#x27;s also say that its the last cycle of job - which automatically kicks off</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">the short-term archiver. If we did &#x27;</span>nothing<span class="string">&#x27;, the 12Z and 18Z get archived</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">and the 18Z gets restaged</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">machine-specific dereferencing</span></span></span><br><span class="line">set nonomatch</span><br><span class="line"></span><br><span class="line">if ($?SLURM_JOB_ID) then</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">SLURM environment variables:</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">env | grep SLURM | sort</span></span></span><br><span class="line"></span><br><span class="line">   setenv ORIGINALDIR $SLURM_SUBMIT_DIR</span><br><span class="line">   setenv     JOBNAME $SLURM_JOB_NAME</span><br><span class="line">   setenv       JOBID $SLURM_JOBID</span><br><span class="line">   setenv     MYQUEUE $SLURM_JOB_PARTITION</span><br><span class="line">   setenv   NODENAMES $SLURM_NODELIST</span><br><span class="line">   setenv LAUNCHCMD &quot;mpirun -np $SLURM_NTASKS -bind-to core&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> untested method for determining NUMTASKS_PERNODE with SLURM</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> set ANY_OLD_NODE = `head -n 1 $SLURM_NODELIST`</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> setenv NUMTASKS_PERNODE `grep $ANY_OLD_NODE $SLURM_NODELIST | wc -l`</span></span></span><br><span class="line"></span><br><span class="line">else if ($?PBS_NODEFILE) then</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">PBS environment variables:</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">env | grep PBS | sort</span></span></span><br><span class="line"></span><br><span class="line">   setenv ORIGINALDIR $PBS_O_WORKDIR</span><br><span class="line">   setenv     JOBNAME $PBS_JOBNAME</span><br><span class="line">   setenv       JOBID $PBS_JOBID</span><br><span class="line">   setenv     MYQUEUE $PBS_O_QUEUE</span><br><span class="line">   setenv     NUMCPUS $NCPUS</span><br><span class="line">   setenv    NUMTASKS `cat  $PBS_NODEFILE | wc -l`</span><br><span class="line">   setenv    NUMNODES `uniq $PBS_NODEFILE | wc -l`</span><br><span class="line">   set ANY_OLD_NODE = `head -n 1 $PBS_NODEFILE`</span><br><span class="line">   setenv    NUMTASKS_PERNODE `grep $ANY_OLD_NODE $PBS_NODEFILE | wc -l`</span><br><span class="line">   setenv  MPIEXEC_MPT_DEBUG 0</span><br><span class="line">   setenv MP_DEBUG_NOTIMEOUT yes</span><br><span class="line">   setenv          LAUNCHCMD mpiexec_mpt</span><br><span class="line"></span><br><span class="line">   echo &quot;jobname        : $JOBNAME&quot;</span><br><span class="line">   echo &quot;numcpus        : $NUMCPUS&quot;</span><br><span class="line">   echo &quot;numtasks       : $NUMTASKS&quot;</span><br><span class="line">   echo &quot;numnodes       : $NUMNODES&quot;</span><br><span class="line">   echo &quot;tasks_per_node : $NUMTASKS_PERNODE&quot;</span><br><span class="line">   echo &quot; &quot;</span><br><span class="line"></span><br><span class="line">else if ($?LSB_HOSTS) then</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">LSF environment variables:</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">env | grep LS | grep -v LS_COLORS | sort</span></span></span><br><span class="line"></span><br><span class="line">   setenv ORIGINALDIR $LS_SUBCWD</span><br><span class="line">   setenv     JOBNAME $LSB_OUTPUTFILE:ar</span><br><span class="line">   setenv       JOBID $LSB_JOBID</span><br><span class="line">   setenv     MYQUEUE $LSB_QUEUE</span><br><span class="line">   setenv   NODENAMES $&#123;LSB_HOSTS&#125;</span><br><span class="line">   setenv MP_DEBUG_NOTIMEOUT yes</span><br><span class="line">   setenv LAUNCHCMD mpirun.lsf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> untested method for determining NUMTASKS_PERNODE with LSF</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> setenv NUMTASKS_PERNODE \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">#     `echo $LSB_SUB_RES_REQ | sed -ne &#x27;</span>/ptile/s<span class="comment">#.*\[ptile=\([0-9][0-9]*\)]#\1#p&#x27;`</span></span></span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 0: Set <span class="built_in">command</span> environment</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This block is an attempt to localize all the machine-specific</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">changes to this script such that the same script can be used</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">on multiple platforms. This will <span class="built_in">help</span> us maintain the script.</span></span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- BEGIN CAM_ASSIMILATE&quot;</span><br><span class="line"></span><br><span class="line">set nonomatch      # suppress &quot;rm&quot; warnings if wildcard does not match anything</span><br><span class="line"></span><br><span class="line">setenv CASEROOT $1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CESM uses C indexing on loops; cycle = [0,....,<span class="variable">$DATA_ASSIMILATION_CYCLES</span> - 1]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;Fix&quot;</span> that here, so the rest of the script isn<span class="string">&#x27;t confusing.</span></span></span><br><span class="line"></span><br><span class="line">@ cycle = $2 + 1</span><br><span class="line"></span><br><span class="line">cd $&#123;CASEROOT&#125;</span><br><span class="line"></span><br><span class="line">setenv scomp                     `./xmlquery COMP_ATM      --value`</span><br><span class="line">setenv CASE                      `./xmlquery CASE          --value`</span><br><span class="line">setenv ensemble_size             `./xmlquery NINST_ATM     --value`</span><br><span class="line">setenv CAM_DYCORE                `./xmlquery CAM_DYCORE    --value`</span><br><span class="line">setenv EXEROOT                   `./xmlquery EXEROOT       --value`</span><br><span class="line">setenv RUNDIR                    `./xmlquery RUNDIR        --value`</span><br><span class="line">setenv archive                   `./xmlquery DOUT_S_ROOT   --value`</span><br><span class="line">setenv TOTALPES                  `./xmlquery TOTALPES      --value`</span><br><span class="line">setenv CONT_RUN                  `./xmlquery CONTINUE_RUN  --value`</span><br><span class="line">setenv CHECK_TIMING              `./xmlquery CHECK_TIMING  --value`</span><br><span class="line">setenv DATA_ASSIMILATION_CYCLES  `./xmlquery DATA_ASSIMILATION_CYCLES --value`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Switch CESM&#x27;</span>s timer script off <span class="keyword">for</span> the rest of the forecasts of this job.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The timer takes a significant amount of time, <span class="built_in">which</span> grows by ~15 s</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">for</span> each cycle.  This can double the cycle time <span class="keyword">in</span> a 2 week job.</span></span><br><span class="line"></span><br><span class="line">./xmlchange CHECK_TIMING=FALSE</span><br><span class="line"></span><br><span class="line">cd $&#123;RUNDIR&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A switch to save all the inflation files</span></span><br><span class="line">setenv save_all_inf TRUE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This may be needed before the short-term archiver has been run.</span></span><br><span class="line">if (! -d $&#123;archive&#125;/esp/hist) mkdir -p $&#123;archive&#125;/esp/hist</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If they exist, mean and sd will always be saved.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">A switch to signal how often to save the stages<span class="string">&#x27; ensemble members.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">    valid values are:  NONE, RESTART_TIMES, ALL</span></span></span><br><span class="line">setenv save_stages_freq RESTART_TIMES</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">This next line ultimately specifies the location of the observation files.</span></span></span><br><span class="line">set BASEOBSDIR = /data2/share/elzd_2024_000125/xhw/downloadData/MLS/2013/Level2/DART_seq</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">suppress &quot;rm&quot; warnings if wildcard does not match anything</span></span></span><br><span class="line">set nonomatch</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Make sure that this script is using standard system commands</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">instead of aliases defined by the user.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If the standard commands are not in the location listed below,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">change the &#x27;</span><span class="built_in">set</span><span class="string">&#x27; commands to use them.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The VERBOSE options are useful for debugging, but are optional because</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">some systems don&#x27;</span>t like the -v option to any of the following.</span></span><br><span class="line"></span><br><span class="line">set   MOVE = &#x27;/usr/bin/mv -v&#x27;</span><br><span class="line">set   COPY = &#x27;/usr/bin/cp -v --preserve=timestamps&#x27;</span><br><span class="line">set   LINK = &#x27;/usr/bin/ln -s&#x27;</span><br><span class="line">set   LIST = &#x27;/usr/bin/ls &#x27;</span><br><span class="line">set REMOVE = &#x27;/usr/bin/rm -r&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 1: Determine time of current model state from file name of member 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">These are of the form <span class="string">&quot;<span class="variable">$&#123;CASE&#125;</span>.cam_<span class="variable">$&#123;ensemble_member&#125;</span>.i.2000-01-06-00000.nc&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Piping stuff through <span class="string">&#x27;bc&#x27;</span> strips off any preceeding zeros.</span></span><br><span class="line"></span><br><span class="line">set FILE = `head -n 1 rpointer.atm_0001`</span><br><span class="line">set FILE = $FILE:r</span><br><span class="line">set ATM_DATE_EXT = $FILE:e</span><br><span class="line">set ATM_DATE     = `echo $FILE:e | sed -e &quot;s#-# #g&quot;`</span><br><span class="line">set ATM_YEAR     = `echo $ATM_DATE[1] | bc`</span><br><span class="line">set ATM_MONTH    = `echo $ATM_DATE[2] | bc`</span><br><span class="line">set ATM_DAY      = `echo $ATM_DATE[3] | bc`</span><br><span class="line">set ATM_SECONDS  = `echo $ATM_DATE[4] | bc`</span><br><span class="line">set ATM_HOUR     = `echo $ATM_DATE[4] / 3600 | bc`</span><br><span class="line"></span><br><span class="line">echo &quot;valid time of model is $ATM_YEAR $ATM_MONTH $ATM_DAY $ATM_SECONDS (seconds)&quot;</span><br><span class="line">echo &quot;valid time of model is $ATM_YEAR $ATM_MONTH $ATM_DAY $ATM_HOUR (hours)&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Move the hidden restart <span class="built_in">set</span> back into <span class="variable">$rundir</span> so that it is processed properly.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;LIST&#125; -d ../Hide*</span></span><br><span class="line">if ($status == 0) then</span><br><span class="line">   echo &#x27;Moving hidden restarts into the run directory so they can be used or purged.&#x27;</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">&#123;MOVE&#125; ../Hide*/* .</span></span><br><span class="line">   rmdir   ../Hide*</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">We need to know the names of the current cesm.log files - one <span class="built_in">log</span> file is created</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">by each CESM model advance.</span></span><br><span class="line"></span><br><span class="line">set log_list = `$&#123;LIST&#125; -t cesm.log.*`</span><br><span class="line"></span><br><span class="line">echo &quot;most recent log is $log_list[1]&quot;</span><br><span class="line">echo &quot;oldest      log is $log_list[$#log_list]&quot;</span><br><span class="line">echo &quot;entire log list is $log_list&quot;</span><br><span class="line">echo &quot; &quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 2: Populate a run-time directory with the input needed to run DART.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- BEGIN COPY BLOCK&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Put a pared down copy (no comments) of input.nml <span class="keyword">in</span> this assimilate_cam directory.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The contents may change from one cycle to the next, so always start from</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the known configuration <span class="keyword">in</span> the CASEROOT directory.</span></span><br><span class="line"></span><br><span class="line">if (  -e   $&#123;CASEROOT&#125;/input.nml ) then</span><br><span class="line"></span><br><span class="line">   sed -e &quot;/#/d;/^\!/d;/^[ ]*\!/d&quot; \</span><br><span class="line">       -e &#x27;1,1i\WARNING: Changes to this file will be ignored. \n Edit \$CASEROOT/input.nml instead.\n\n\n&#x27; \</span><br><span class="line">       $&#123;CASEROOT&#125;/input.nml &gt;! input.nml  || exit 10</span><br><span class="line">else</span><br><span class="line">   echo &quot;ERROR ... DART required file $&#123;CASEROOT&#125;/input.nml not found ... ERROR&quot;</span><br><span class="line">   echo &quot;ERROR ... DART required file $&#123;CASEROOT&#125;/input.nml not found ... ERROR&quot;</span><br><span class="line">   exit 11</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- END COPY BLOCK&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If possible, use the round-robin approach to deal out the tasks.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This facilitates using multiple nodes <span class="keyword">for</span> the simultaneous I/O operations.</span></span><br><span class="line"></span><br><span class="line">if ($?NUMTASKS_PERNODE) then</span><br><span class="line">   if ($#NUMTASKS_PERNODE &gt; 0) then</span><br><span class="line">      $&#123;MOVE&#125; input.nml input.nml.$$ || exit 20</span><br><span class="line">      sed -e &quot;s#layout.*#layout = 2#&quot; \</span><br><span class="line">          -e &quot;s#tasks_per_node.*#tasks_per_node = $NUMTASKS_PERNODE#&quot; \</span><br><span class="line">          input.nml.$$ &gt;! input.nml || exit 21</span><br><span class="line">      $&#123;REMOVE&#125; -f input.nml.$$</span><br><span class="line">   endif</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 3: Identify requested output stages, warn about redundant output.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"></span><br><span class="line">set MYSTRING = `grep stages_to_write input.nml`</span><br><span class="line">set MYSTRING = (`echo $MYSTRING | sed -e &quot;s#[=,&#x27;\.]# #g&quot;`)</span><br><span class="line">set STAGE_input     = FALSE</span><br><span class="line">set STAGE_forecast  = FALSE</span><br><span class="line">set STAGE_preassim  = FALSE</span><br><span class="line">set STAGE_postassim = FALSE</span><br><span class="line">set STAGE_analysis  = FALSE</span><br><span class="line">set STAGE_output    = FALSE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Assemble lists of stages to write out, <span class="built_in">which</span> are not the <span class="string">&#x27;output&#x27;</span> stage.</span></span><br><span class="line"></span><br><span class="line">set stages_except_output = &quot;&#123;&quot;</span><br><span class="line">@ stage = 2</span><br><span class="line">while ($stage &lt;= $#MYSTRING)</span><br><span class="line">   if ($MYSTRING[$stage] == &#x27;input&#x27;) then</span><br><span class="line">      set STAGE_input = TRUE</span><br><span class="line">      if ($stage &gt; 2) set stages_except_output = &quot;$&#123;stages_except_output&#125;,&quot;</span><br><span class="line">      set stages_except_output = &quot;$&#123;stages_except_output&#125;input&quot;</span><br><span class="line">   endif</span><br><span class="line">   if ($MYSTRING[$stage] == &#x27;forecast&#x27;) then</span><br><span class="line">      set STAGE_forecast = TRUE</span><br><span class="line">      if ($stage &gt; 2) set stages_except_output = &quot;$&#123;stages_except_output&#125;,&quot;</span><br><span class="line">      set stages_except_output = &quot;$&#123;stages_except_output&#125;forecast&quot;</span><br><span class="line">   endif</span><br><span class="line">   if ($MYSTRING[$stage] == &#x27;preassim&#x27;) then</span><br><span class="line">      set STAGE_preassim = TRUE</span><br><span class="line">      if ($stage &gt; 2) set stages_except_output = &quot;$&#123;stages_except_output&#125;,&quot;</span><br><span class="line">      set stages_except_output = &quot;$&#123;stages_except_output&#125;preassim&quot;</span><br><span class="line">   endif</span><br><span class="line">   if ($MYSTRING[$stage] == &#x27;postassim&#x27;) then</span><br><span class="line">      set STAGE_postassim = TRUE</span><br><span class="line">      if ($stage &gt; 2) set stages_except_output = &quot;$&#123;stages_except_output&#125;,&quot;</span><br><span class="line">      set stages_except_output = &quot;$&#123;stages_except_output&#125;postassim&quot;</span><br><span class="line">   endif</span><br><span class="line">   if ($MYSTRING[$stage] == &#x27;analysis&#x27;) then</span><br><span class="line">      set STAGE_analysis = TRUE</span><br><span class="line">      if ($stage &gt; 2) set stages_except_output = &quot;$&#123;stages_except_output&#125;,&quot;</span><br><span class="line">      set stages_except_output = &quot;$&#123;stages_except_output&#125;analysis&quot;</span><br><span class="line">   endif</span><br><span class="line">   if ($stage == $#MYSTRING) then</span><br><span class="line">      set stages_all = &quot;$&#123;stages_except_output&#125;&quot;</span><br><span class="line">      if ($MYSTRING[$stage] == &#x27;output&#x27;) then</span><br><span class="line">         set STAGE_output = TRUE</span><br><span class="line">         set stages_all = &quot;$&#123;stages_all&#125;,output&quot;</span><br><span class="line">      endif</span><br><span class="line">   endif</span><br><span class="line">   @ stage++</span><br><span class="line">end</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Add the closing &#125;</span></span><br><span class="line">set stages_all = &quot;$&#123;stages_all&#125;&#125;&quot;</span><br><span class="line">set stages_except_output = &quot;$&#123;stages_except_output&#125;&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Checking</span></span><br><span class="line">echo &quot;stages_except_output = $stages_except_output&quot;</span><br><span class="line">echo &quot;stages_all = $stages_all&quot;</span><br><span class="line">if ($STAGE_output != TRUE) then</span><br><span class="line">   echo &quot;ERROR: assimilate.csh requires that input.nml:filter_nml:stages_to_write includes stage &#x27;output&#x27;&quot;</span><br><span class="line">   exit 40</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 4: Preliminary clean up, <span class="built_in">which</span> can run <span class="keyword">in</span> the background.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CESM2_0<span class="string">&#x27;s new archiver has a mechanism for removing restart file sets,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">which we don&#x27;</span>t need, but it runs only after the (multicycle) job finishes.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">We<span class="string">&#x27;d like to remove unneeded restarts as the job progresses, allowing more</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">cycles to run before needing to stop to archive data.  So clean them out of</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">RUNDIR, and st_archive will never have to deal with them.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">------------------------------------------------------------------------------</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">For safety, leave the most recent *2* restart sets in place.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Prevents catastrophe if the last restart set is partially written before a crash.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Add 1 more because the restart set used to start this will be counted:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">there will be 3 restarts when there are only 2 cesm.log files,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">which caused all the files to be deleted.</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">## edited by xhw ###</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">- following code was added for convenient to control the run</span></span></span><br><span class="line">set if_save_initial=&#x27;true&#x27;</span><br><span class="line">if ($if_save_initial == &#x27;true&#x27;) then</span><br><span class="line">   set re_list = `$&#123;LIST&#125; -t *cpl_0001.r.*`</span><br><span class="line"></span><br><span class="line">   set FILE = $re_list[1]</span><br><span class="line">   set FILE = $FILE:r</span><br><span class="line">   if ($FILE:e == &#x27;nc&#x27;) set FILE = $FILE:r</span><br><span class="line">   set rm_date = $FILE:e</span><br><span class="line">   set RM_DATE_PARTS = `echo $rm_date | sed -e &quot;s#-# #g&quot;`</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">find the current model time from cpl.log file</span></span></span><br><span class="line">   set day_o_month = $RM_DATE_PARTS[3]</span><br><span class="line">   set sec_o_day   = $RM_DATE_PARTS[4]</span><br><span class="line">   set day_time    = $&#123;day_o_month&#125;-$&#123;sec_o_day&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">mkdir -p histfiles</span></span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">$&#123;COPY&#125; $&#123;CASE&#125;*.&#123;h0,h1&#125;.[0-9]*$&#123;day_time&#125;*  ./histfiles/ &amp;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">clean &#123;ha2x1h,ha2x1hi,ha2x3h,hr2x,ha2x1h&#125; files of last cycle</span></span></span><br><span class="line">   if ($#re_list &gt;= 2) then</span><br><span class="line">      set FILE_last = $re_list[2]</span><br><span class="line">      set FILE_last = $FILE_last:r</span><br><span class="line">      if ($FILE_last:e == &#x27;nc&#x27;) set FILE_last = $FILE_last:r</span><br><span class="line">      set rm_date_last = $FILE_last:e</span><br><span class="line">      set RM_DATE_PARTS_last = `echo $rm_date_last | sed -e &quot;s#-# #g&quot;`</span><br><span class="line">      set day_o_month_last = $RM_DATE_PARTS_last[3]</span><br><span class="line">      set sec_o_day_last   = $RM_DATE_PARTS_last[4]</span><br><span class="line">      set day_time_last    = $&#123;day_o_month_last&#125;-$&#123;sec_o_day_last&#125;</span><br><span class="line">      $&#123;REMOVE&#125; $&#123;CASE&#125;*.&#123;ha2x1h,ha2x1hi,ha2x3h,hr2x,ha2x1h&#125;.*$&#123;day_time_last&#125;* &amp;</span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">backup the initial files</span></span> </span><br><span class="line">   if ($sec_o_day =~ &#x27;00000&#x27;) then</span><br><span class="line"></span><br><span class="line">      ### edited by xhw 2024-08-03 ###</span><br><span class="line">      mkdir -p initialfiles</span><br><span class="line">      $&#123;COPY&#125; $&#123;CASE&#125;*.i.[0-9]*$&#123;day_time&#125;* ./initialfiles/  &amp;</span><br><span class="line">      ###--------------------------###</span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">use changeSDdate.sh under CASEROOT to change the nudging timestamp</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">nudging timestamp must be changed to current model datetime</span></span></span><br><span class="line">   set formatted_month = `printf &quot;%02d&quot; $ATM_MONTH`</span><br><span class="line">   set formatted_day = `printf &quot;%02d&quot; $ATM_DAY`</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">CASEROOT/changeSDdate.sh $CASEROOT $&#123;ATM_YEAR&#125;$&#123;formatted_month&#125;$&#123;formatted_day&#125;</span></span></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">- below are the content of changeSDdate.sh</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">caseroot=$1</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">newdate=$2</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">for dd in $(seq 1 5); do</span></span></span><br><span class="line">      # filename=&quot;user_nl_cam_000$dd&quot;</span><br><span class="line">      # # 使用 sed 修改 met_data_file 变量中的日期字段</span><br><span class="line">      # sed -i &quot;s/\(met_data_file          =.*_\)[0-9]\&#123;8\&#125;\(.*\)/\1$&#123;newdate&#125;\2/&quot; &quot;$caseroot/$filename&quot;</span><br><span class="line"></span><br><span class="line">      # # 输出结果</span><br><span class="line">      # if [ $? -eq 0 ]; then</span><br><span class="line">      #     echo &quot;文件 $filename 中的 met_data_file 变量的日期字段已修改为 $newdate。&quot;</span><br><span class="line">      # else</span><br><span class="line">      #     echo &quot;修改文件 $filename 中的 met_data_file 变量的日期字段失败。&quot;</span><br><span class="line">      # fi</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">done</span></span></span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">--------------------------#</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">## edited by xhw, ($#log_list &gt;= 5)</span></span></span><br><span class="line">if ($#log_list &gt;= 5) then</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">List of potential restart sets to remove. The coupler restart files</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">may or may not have an &#x27;</span>instance<span class="string">&#x27; string in them, depending on whether</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">or not you are using the multi-driver or not, so we must check for both.</span></span></span><br><span class="line"></span><br><span class="line">   set re_list = `$&#123;LIST&#125; -t *cpl.r.*`</span><br><span class="line">   if ($#re_list == 0) set re_list = `$&#123;LIST&#125; -t *cpl_0001.r.*`</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">## edited by xhw, just set ($#re_list &lt; 5)</span></span></span><br><span class="line">   if ($#re_list &lt; 5) then</span><br><span class="line">      echo &quot;ERROR: Too many cesm.log files ($#log_list) for the $#re_list restart sets.&quot;</span><br><span class="line">      echo &quot;       Clean out the cesm.log files from failed cycles.&quot;</span><br><span class="line">      exit 50</span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Find the date of the oldest restart set from filenames like:</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">setup_test.cpl_0001.r.2016-12-11-21600.nc   ... or ...</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">setup_test.cpl.r.2016-12-11-21600.nc</span></span></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash">   # Grab the root of the filename (removes the .nc &#x27;</span>extension<span class="string">&#x27;)</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">and then the extension is the bit we need.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Want the YYYY-MM-DD-SSSSS part as well as &#x27;</span>DD-SSSSS<span class="string">&#x27;</span></span></span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">## edited by xhw ###</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">- we want to keep the last four restart files under the folder</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">- so when ($#log_list &gt;= 5), we remove the 5th file</span></span></span><br><span class="line">   set FILE = $re_list[5]  </span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">--------------- ###</span></span></span><br><span class="line">   set FILE = $FILE:r</span><br><span class="line">   if ($FILE:e == &#x27;nc&#x27;) set FILE = $FILE:r</span><br><span class="line">   set rm_date = $FILE:e</span><br><span class="line">   set RM_DATE_PARTS = `echo $rm_date | sed -e &quot;s#-# #g&quot;`</span><br><span class="line">   set day_o_month = $RM_DATE_PARTS[3]</span><br><span class="line">   set sec_o_day   = $RM_DATE_PARTS[4]</span><br><span class="line">   set day_time    = $&#123;day_o_month&#125;-$&#123;sec_o_day&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Decide whether to purge restart files at this date and time.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">edited by xhw, just set 3 to 4</span></span></span><br><span class="line">   set save_rest_freq = 4</span><br><span class="line"></span><br><span class="line">   set purge = &#x27;true&#x27;</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Learn whether save_rest_freq a string or a number.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Character strings must be tested outside of the &#x27;</span><span class="keyword">if</span><span class="string">&#x27; statement.</span></span></span><br><span class="line">   echo $save_rest_freq | grep &#x27;[a-z]&#x27;</span><br><span class="line">   if ($status == 0) then</span><br><span class="line">      set purge_date = $RM_DATE_PARTS[1]-$RM_DATE_PARTS[2]-$RM_DATE_PARTS[3]</span><br><span class="line">      set weekday = `date --date=&quot;$purge_date&quot; +%A`</span><br><span class="line">      if ($weekday == $save_rest_freq) set purge = &#x27;false&#x27;</span><br><span class="line"> </span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Numbers can be tested inside the &#x27;</span><span class="keyword">if</span><span class="string">&#x27; statement.</span></span></span><br><span class="line">   else if (`echo $save_rest_freq | grep &#x27;[0-9]&#x27;`) then</span><br><span class="line">      if ($&#123;day_o_month&#125; % $&#123;save_rest_freq&#125; == 0) set purge = &#x27;false&#x27;</span><br><span class="line"> </span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Identify log files to be removed or moved.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">[3] means the 3rd oldest restart set is being (re)moved.</span></span></span><br><span class="line">   set rm_log = `echo $log_list[3] | sed -e &quot;s/\./ /g;&quot;`</span><br><span class="line">   set rm_slot = $#rm_log</span><br><span class="line">   if ($rm_log[$#rm_log] == &#x27;gz&#x27;) @ rm_slot--</span><br><span class="line">   echo &#x27;oldest restart set is from job tagged $rm_log[&#x27;$rm_slot&#x27;]=&#x27;$rm_log[$rm_slot]</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">This first half of the statement removes unwanted restarts.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">The &#x27;</span><span class="keyword">else</span><span class="string">&#x27; block preserves the restarts in the archive directory.</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">## edited by xhw ###</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">- Regardless of whether the mode time is equal to &quot;00000&quot;, run the code below</span></span></span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_">   #</span><span class="language-bash"><span class="string">if ( $sec_o_day !~ &#x27;</span>00000<span class="string">&#x27; || \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">   #    ($sec_o_day =~ &#x27;</span>00000<span class="string">&#x27; &amp;&amp; $purge == &#x27;</span><span class="literal">true</span><span class="string">&#x27;) ) then</span></span></span><br><span class="line">    if ( ( $sec_o_day !~ &#x27;00000&#x27;) || ( $sec_o_day =~ &#x27;00000&#x27;) ) then</span><br><span class="line">    </span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">--------------- ###</span></span></span><br><span class="line">      # Optionally save inflation restarts, even if it&#x27;s not a &#x27;save restart&#x27; time.</span><br><span class="line">      if ($save_all_inf =~ TRUE) $&#123;MOVE&#125; $&#123;CASE&#125;*inf*$&#123;day_time&#125;*  $&#123;archive&#125;/esp/hist</span><br><span class="line"></span><br><span class="line">      # Remove intermediate member restarts,</span><br><span class="line">      # but not DART means, sd, obs_seq, inflation restarts output.</span><br><span class="line">      # Note that *cpl.h[ar]* are retained, and any h#, #&gt;0.</span><br><span class="line"></span><br><span class="line">      ### edited by xhw ###</span><br><span class="line">      # - change &#123;r,rs,rs1,rh0,h0&#125; to &#123;r,rs,rs1,rh0&#125;</span><br><span class="line">      # - do not remove history files, and add &quot;set nonomatch&quot;</span><br><span class="line">      set nonomatch</span><br><span class="line">      echo &quot;Removing unneeded restart file set (DD_SSSSS $&#123;day_time&#125;) from RUNDIR: &quot;</span><br><span class="line">      echo &quot;     $&#123;CASE&#125;&quot;&#x27;*.&#123;r,rs,rs1,rh0&#125;.*&#x27;&quot;$&#123;day_time&#125;&quot;</span><br><span class="line">      $&#123;REMOVE&#125;  $&#123;CASE&#125;*.&#123;r,rs,rs1,rh0&#125;.*$&#123;day_time&#125;* </span><br><span class="line"></span><br><span class="line">      # ---------------###</span><br><span class="line"></span><br><span class="line">      # Handle .i. separately to avoid sweeping up .i.$&#123;scomp&#125;_&#123;in,out&#125;put_&#123;mean,sd,...&#125; files.</span><br><span class="line">      echo &quot;     $&#123;CASE&#125;&quot;&#x27;*.i.[0-9]*&#x27;&quot;$&#123;day_time&#125;&quot;</span><br><span class="line">      ### edited by xhw ###</span><br><span class="line">      # - $&#123;REMOVE&#125; can make us lose initial and history files</span><br><span class="line">      # - so just comment the line below</span><br><span class="line"></span><br><span class="line">      #$&#123;REMOVE&#125; $&#123;CASE&#125;*.i.[0-9]*$&#123;day_time&#125;*  &amp;</span><br><span class="line">      # --------------- ###</span><br><span class="line">      if ($save_stages_freq =~ NONE || $save_stages_freq =~ RESTART_TIMES) then</span><br><span class="line">         # &#x27;output&#x27; will have been renamed by the time the purging happens.</span><br><span class="line">         echo &quot;     $&#123;CASE&#125;&quot;&#x27;*&#x27;[0-9].$&#123;stages_except_output&#125;&#x27;*&#x27;$&#123;day_time&#125;</span><br><span class="line"></span><br><span class="line">         ### edited by xhw ###</span><br><span class="line">         # - $&#123;REMOVE&#125; can make us lose initial and history files</span><br><span class="line">         # - so just comment the line below</span><br><span class="line"></span><br><span class="line">         # $&#123;REMOVE&#125;  $&#123;CASE&#125;.*[0-9].$&#123;stages_except_output&#125;*$&#123;day_time&#125;* &amp;</span><br><span class="line">         # ------------------#</span><br><span class="line">      endif</span><br><span class="line">   else</span><br><span class="line"></span><br><span class="line">      echo &quot;Preserving (compressed) restart file set (DD_SSSSS $&#123;day_time&#125;)&quot;</span><br><span class="line"></span><br><span class="line">      # Optionally COPY inflation restarts to the same place as the other inflation restarts.</span><br><span class="line">      if ($save_all_inf =~ TRUE) then</span><br><span class="line">          $&#123;COPY&#125; $&#123;CASE&#125;*inf*$&#123;day_time&#125;*  $&#123;archive&#125;/esp/hist &amp;</span><br><span class="line">      endif</span><br><span class="line"></span><br><span class="line">      # Optionally REMOVE stages&#x27; ensemble members (not means and sds).</span><br><span class="line">      if ($save_stages_freq =~ NONE ) then</span><br><span class="line">         echo &quot;Removing unneeded stages&#x27; ensemble members (DD_SSSSS $&#123;day_time&#125;) from RUNDIR: &quot;</span><br><span class="line">         echo &quot;     $&#123;CASE&#125;&quot;&#x27;*&#x27;[0-9].$&#123;stages_except_output&#125;&#x27;*&#x27;$&#123;day_time&#125;</span><br><span class="line">         $&#123;REMOVE&#125;  $&#123;CASE&#125;.*[0-9].$&#123;stages_except_output&#125;*$&#123;day_time&#125;* &amp;</span><br><span class="line">      endif</span><br><span class="line"></span><br><span class="line">      wait</span><br><span class="line"></span><br><span class="line">      # The list of components determines which restarts are compressed by this call.</span><br><span class="line">      # List the large files first (more efficient and reliable).</span><br><span class="line">      # There is another call farther down to compress the DART files every cycle.</span><br><span class="line">      echo &quot;compress.csh started at `date`&quot;</span><br><span class="line">      </span><br><span class="line">      ### edited by xhw 2024-08-03  ###</span><br><span class="line">      # - we don&#x27;t need to compress any files</span><br><span class="line">      # - commenting the codes below is just ok</span><br><span class="line">      </span><br><span class="line">      # $&#123;CASEROOT&#125;/compress.csh $CASE $&#123;rm_date&#125; $ensemble_size &quot;clm2 cpl cam cice&quot; &quot;$stages_all&quot;</span><br><span class="line">      #if ($status != 0) then</span><br><span class="line">      #   echo &quot;compress.csh failed at `date`&quot;</span><br><span class="line">      #   exit 55</span><br><span class="line">      #endif</span><br><span class="line">      #echo &quot;compress.csh finished at `date`&quot;</span><br><span class="line">      ### -------------------------###</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      # Save the restart set to archive/rest/$datename,</span><br><span class="line">      # where it will be safe from removes of $component/rest.</span><br><span class="line">      # There is an implicit assumption that some sort of inflation will be used.</span><br><span class="line"></span><br><span class="line">      set save_root = $&#123;archive&#125;/rest/$&#123;rm_date&#125;</span><br><span class="line">      if (! -d $save_root) then</span><br><span class="line">         mkdir -p $save_root</span><br><span class="line">         ($&#123;MOVE&#125; $&#123;CASE&#125;*.&#123;r,rs,rs1,rh0,h0&#125;.*$&#123;day_time&#125;*  $save_root || exit 60) &amp;</span><br><span class="line">         ($&#123;MOVE&#125; $&#123;CASE&#125;*.i.[0-9]*$&#123;day_time&#125;*             $save_root || exit 61) &amp;</span><br><span class="line">         ($&#123;COPY&#125; *.output*inf*$&#123;day_time&#125;*                 $save_root || exit 62) &amp;</span><br><span class="line">         ($&#123;MOVE&#125; *0001*$&#123;rm_log[$rm_slot]&#125;*                $save_root || exit 63) &amp;</span><br><span class="line">         ($&#123;MOVE&#125; cesm*$&#123;rm_log[$rm_slot]&#125;*                 $save_root || exit 64) &amp;</span><br><span class="line">      else</span><br><span class="line">         echo &quot;WARNING: $save_root already exists.  Did st_archive make it?&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">         exit 65</span></span></span><br><span class="line">      endif</span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Remove log files: *YYMMDD-HHMMSS*.  Except not da.log files</span></span></span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;REMOVE&#125;  [^d]*$&#123;rm_log[$rm_slot]&#125;*  &amp;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">I&#x27;</span>d like to remove the CAM .r. files, since we always use the .i. files to <span class="keyword">do</span> a hybrid start,</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">but apparently CESM needs them to be there, even though it doesn<span class="string">&#x27;t read fields from them.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">$&#123;REMOVE&#125;  $&#123;CASE&#125;.cam*.r.*$&#123;day_time&#125;.nc &amp;</span></span></span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Block 5: Get observation sequence file ... or die right away.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The observation file names have a time that matches the stopping time of CAM.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Make sure the file name structure matches the obs you will be using.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">PERFECT model obs output appends .perfect to the filenames</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"></span><br><span class="line">set YYYYMM = `printf %04d%02d $&#123;ATM_YEAR&#125; $&#123;ATM_MONTH&#125;`</span><br><span class="line"></span><br><span class="line">if (! -d $&#123;BASEOBSDIR&#125;/$&#123;YYYYMM&#125;_6H_CESM) then</span><br><span class="line">   echo &quot;CESM+DART requires 6 hourly obs_seq files in directories of the form YYYYMM_6H_CESM&quot;</span><br><span class="line">   echo &quot;The directory $&#123;BASEOBSDIR&#125;/$&#123;YYYYMM&#125;_6H_CESM is not found.  Exiting&quot;</span><br><span class="line">   exit 70</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">set OBSFNAME = `printf obs_seq.%04d-%02d-%02d-%05d $&#123;ATM_YEAR&#125; $&#123;ATM_MONTH&#125; $&#123;ATM_DAY&#125; $&#123;ATM_SECONDS&#125;`</span><br><span class="line"></span><br><span class="line">set OBS_FILE = $&#123;BASEOBSDIR&#125;/$&#123;YYYYMM&#125;_6H_CESM/$&#123;OBSFNAME&#125;</span><br><span class="line">echo &quot;OBS_FILE = $OBS_FILE&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;REMOVE&#125; obs_seq.out</span></span></span><br><span class="line">if (  -e $&#123;OBS_FILE&#125; ) then</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;LINK&#125; $&#123;OBS_FILE&#125; obs_seq.out || exit 80</span></span></span><br><span class="line">else</span><br><span class="line">   echo &quot;ERROR ... no observation file $&#123;OBS_FILE&#125;&quot;</span><br><span class="line">   echo &quot;ERROR ... no observation file $&#123;OBS_FILE&#125;&quot;</span><br><span class="line">   exit 81</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Block 6: DART INFLATION</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">This block is only relevant if &#x27;</span>inflation<span class="string">&#x27; is turned on AND</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">inflation values change through time:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">filter_nml</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">   inf_flavor(:)  = 2  (or 3 (or 4 for posterior))</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">   inf_initial_from_restart    = .TRUE.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">   inf_sd_initial_from_restart = .TRUE.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># This block stages the files that contain the inflation values.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The inflation files are essentially duplicates of the DART model state,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">which have names in the CESM style, something like</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">   $&#123;case&#125;.dart.rh.$&#123;scomp&#125;_output_priorinf_&#123;mean,sd&#125;.YYYY-MM-DD-SSSSS.nc</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The strategy is to use the latest such files in $&#123;RUNDIR&#125;.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If those don&#x27;</span>t exist at the start of an assimilation,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this block creates them with <span class="string">&#x27;fill_inflation_restart&#x27;</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If they don<span class="string">&#x27;t exist AFTER the first cycle, the script will exit</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">because they should have been available from a previous cycle.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The script does NOT check the model date of the files for consistency</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">with the current forecast time, so check that the inflation mean</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">files are evolving as expected.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># CESM&#x27;</span>s st_archive should archive the inflation restart files</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">like any other <span class="string">&quot;restart history&quot;</span> (.rh.) files; copying the latest files</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">to the archive directory, and moving all of the older ones.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If we need to run fill_inflation_restart, CAM:static_init_model()</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">always needs a caminput.nc and a cam_phis.nc <span class="keyword">for</span> geometry information, etc.</span></span><br><span class="line"></span><br><span class="line">set MYSTRING = `grep cam_template_filename input.nml`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;]# #g&quot;`</span><br><span class="line">set CAMINPUT = $MYSTRING[2]</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;REMOVE&#125; <span class="variable">$&#123;CAMINPUT&#125;</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;LINK&#125; <span class="variable">$&#123;CASE&#125;</span>.cam_0001.i.<span class="variable">$&#123;ATM_DATE_EXT&#125;</span>.nc <span class="variable">$&#123;CAMINPUT&#125;</span> || <span class="built_in">exit</span> 90</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">All of the .h0. files contain the same PHIS field, so we can <span class="built_in">link</span> to any of them.</span></span><br><span class="line">set MYSTRING = `grep cam_phis_filename input.nml`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;]# #g&quot;`</span><br><span class="line">set CAM_PHIS = $MYSTRING[2]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Listings are slow <span class="keyword">in</span> productions runs; only <span class="keyword">do</span> it <span class="keyword">if</span> necessary</span></span><br><span class="line">if (! -f $&#123;CAM_PHIS&#125;) then</span><br><span class="line">   set hists = `$&#123;LIST&#125; $&#123;CASE&#125;.cam_0001.h0.*.nc`</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">&#123;COPY&#125; <span class="variable">$hists</span>[1] <span class="variable">$&#123;CAM_PHIS&#125;</span> || <span class="built_in">exit</span> 100</span></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Now, actually check the inflation settings</span></span><br><span class="line"></span><br><span class="line">set  MYSTRING = `grep inf_flavor input.nml`</span><br><span class="line">set  MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;\.]# #g&quot;`</span><br><span class="line">set  PRIOR_INF = $MYSTRING[2]</span><br><span class="line">set  POSTE_INF = $MYSTRING[3]</span><br><span class="line"></span><br><span class="line">set  MYSTRING = `grep inf_initial_from_restart input.nml`</span><br><span class="line">set  MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;\.]# #g&quot;`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If no inflation is requested, the inflation restart <span class="built_in">source</span> is ignored</span></span><br><span class="line"></span><br><span class="line">if ( $PRIOR_INF == 0 ) then</span><br><span class="line">   set  PRIOR_INFLATION_FROM_RESTART = ignored</span><br><span class="line">   set  USING_PRIOR_INFLATION = false</span><br><span class="line">else</span><br><span class="line">   set  PRIOR_INFLATION_FROM_RESTART = `echo $MYSTRING[2] | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;`</span><br><span class="line">   set  USING_PRIOR_INFLATION = true</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">if ( $POSTE_INF == 0 ) then</span><br><span class="line">   set  POSTE_INFLATION_FROM_RESTART = ignored</span><br><span class="line">   set  USING_POSTE_INFLATION = false</span><br><span class="line">else</span><br><span class="line">   set  POSTE_INFLATION_FROM_RESTART = `echo $MYSTRING[3] | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;`</span><br><span class="line">   set  USING_POSTE_INFLATION = true</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">if ($USING_PRIOR_INFLATION == false ) then</span><br><span class="line">   set stages_requested = 0</span><br><span class="line">   if ( $STAGE_input    == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $STAGE_forecast == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $STAGE_preassim == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $stages_requested &gt; 1 ) then</span><br><span class="line">      echo &quot; &quot;</span><br><span class="line">      echo &quot;WARNING ! ! Redundant output is requested at multiple stages before assimilation.&quot;</span><br><span class="line">      echo &quot;            Stages &#x27;input&#x27; and &#x27;forecast&#x27; are always redundant.&quot;</span><br><span class="line">      echo &quot;            Prior inflation is OFF, so stage &#x27;preassim&#x27; is also redundant. &quot;</span><br><span class="line">      echo &quot;            We recommend requesting just &#x27;preassim&#x27;.&quot;</span><br><span class="line">      echo &quot; &quot;</span><br><span class="line">   endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">if ($USING_POSTE_INFLATION == false ) then</span><br><span class="line">   set stages_requested = 0</span><br><span class="line">   if ( $STAGE_postassim == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $STAGE_analysis  == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $STAGE_output    == TRUE ) @ stages_requested++</span><br><span class="line">   if ( $stages_requested &gt; 1 ) then</span><br><span class="line">      echo &quot; &quot;</span><br><span class="line">      echo &quot;WARNING ! ! Redundant output is requested at multiple stages after assimilation.&quot;</span><br><span class="line">      echo &quot;            Stages &#x27;output&#x27; and &#x27;analysis&#x27; are always redundant.&quot;</span><br><span class="line">      echo &quot;            Posterior inflation is OFF, so stage &#x27;postassim&#x27; is also redundant. &quot;</span><br><span class="line">      echo &quot;            We recommend requesting just &#x27;output&#x27;.&quot;</span><br><span class="line">      echo &quot; &quot;</span><br><span class="line">   endif</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IFF we want PRIOR inflation:</span></span><br><span class="line"></span><br><span class="line">if ($USING_PRIOR_INFLATION == true) then</span><br><span class="line">   if ($PRIOR_INFLATION_FROM_RESTART == false) then</span><br><span class="line"></span><br><span class="line">      echo &quot;inf_flavor(1) = $PRIOR_INF, using namelist values.&quot;</span><br><span class="line"></span><br><span class="line">   else</span><br><span class="line">      # Look for the output from the previous assimilation (or fill_inflation_restart)</span><br><span class="line">      # If inflation files exists, use them as input for this assimilation</span><br><span class="line">      ($&#123;LIST&#125; -rt1 *.dart.rh.$&#123;scomp&#125;_output_priorinf_mean* | tail -n 1 &gt;! latestfile) &gt; &amp; /dev/null</span><br><span class="line">      ($&#123;LIST&#125; -rt1 *.dart.rh.$&#123;scomp&#125;_output_priorinf_sd*   | tail -n 1 &gt;&gt; latestfile) &gt; &amp; /dev/null</span><br><span class="line">      set nfiles = `cat latestfile | wc -l`</span><br><span class="line"></span><br><span class="line">      if ( $nfiles &gt; 0 ) then</span><br><span class="line"></span><br><span class="line">         set latest_mean = `head -n 1 latestfile`</span><br><span class="line">         set latest_sd   = `tail -n 1 latestfile`</span><br><span class="line">         # Need to COPY instead of link because of short-term archiver and disk management.</span><br><span class="line">         $&#123;COPY&#125; $latest_mean input_priorinf_mean.nc</span><br><span class="line">         $&#123;COPY&#125; $latest_sd   input_priorinf_sd.nc</span><br><span class="line"></span><br><span class="line">      else if ($CONT_RUN == FALSE) then</span><br><span class="line"></span><br><span class="line">         # It&#x27;s the first assimilation; try to find some inflation restart files</span><br><span class="line">         # or make them using fill_inflation_restart.</span><br><span class="line">         # Fill_inflation_restart needs caminput.nc and cam_phis.nc for static_model_init,</span><br><span class="line">         # so this staging is done in assimilate.csh (after a forecast) instead of stage_cesm_files.</span><br><span class="line"></span><br><span class="line">         if (-x $&#123;EXEROOT&#125;/fill_inflation_restart) then</span><br><span class="line"></span><br><span class="line">            $&#123;EXEROOT&#125;/fill_inflation_restart</span><br><span class="line"></span><br><span class="line">         else</span><br><span class="line">            echo &quot;ERROR: Requested PRIOR inflation restart for the first cycle.&quot;</span><br><span class="line">            echo &quot;       There are no existing inflation files available &quot;</span><br><span class="line">            echo &quot;       and $&#123;EXEROOT&#125;/fill_inflation_restart is missing.&quot;</span><br><span class="line">            echo &quot;EXITING&quot;</span><br><span class="line">            exit 112</span><br><span class="line">         endif</span><br><span class="line"></span><br><span class="line">      else</span><br><span class="line">         echo &quot;ERROR: Requested PRIOR inflation restart, &quot;</span><br><span class="line">         echo &#x27;       but files *.dart.rh.$&#123;scomp&#125;_output_priorinf_* do not exist in the $&#123;RUNDIR&#125;.&#x27;</span><br><span class="line">         echo &#x27;       If you are changing from cam_no_assimilate.csh to assimilate.csh,&#x27;</span><br><span class="line">         echo &#x27;       you might be able to continue by changing CONTINUE_RUN = FALSE for this cycle,&#x27;</span><br><span class="line">         echo &#x27;       and restaging the initial ensemble.&#x27;</span><br><span class="line">         $&#123;LIST&#125; -l *inf*</span><br><span class="line">         echo &quot;EXITING&quot;</span><br><span class="line">         exit 115</span><br><span class="line">      endif</span><br><span class="line">   endif</span><br><span class="line">else</span><br><span class="line">   echo &quot;Prior Inflation not requested for this assimilation.&quot;</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">POSTERIOR: We look <span class="keyword">for</span> the <span class="string">&#x27;newest&#x27;</span> and use it - IFF we need it.</span></span><br><span class="line"></span><br><span class="line">if ($USING_POSTE_INFLATION == true) then</span><br><span class="line">   if ($POSTE_INFLATION_FROM_RESTART == false) then</span><br><span class="line"></span><br><span class="line">      # we are not using an existing inflation file.</span><br><span class="line">      echo &quot;inf_flavor(2) = $POSTE_INF, using namelist values.&quot;</span><br><span class="line"></span><br><span class="line">   else</span><br><span class="line">      # Look for the output from the previous assimilation (or fill_inflation_restart).</span><br><span class="line">      # (The only stage after posterior inflation.)</span><br><span class="line">      ($&#123;LIST&#125; -rt1 *.dart.rh.$&#123;scomp&#125;_output_postinf_mean* | tail -n 1 &gt;! latestfile) &gt; &amp; /dev/null</span><br><span class="line">      ($&#123;LIST&#125; -rt1 *.dart.rh.$&#123;scomp&#125;_output_postinf_sd*   | tail -n 1 &gt;&gt; latestfile) &gt; &amp; /dev/null</span><br><span class="line">      set nfiles = `cat latestfile | wc -l`</span><br><span class="line"></span><br><span class="line">      # If one exists, use it as input for this assimilation</span><br><span class="line">      if ( $nfiles &gt; 0 ) then</span><br><span class="line"></span><br><span class="line">         set latest_mean = `head -n 1 latestfile`</span><br><span class="line">         set latest_sd   = `tail -n 1 latestfile`</span><br><span class="line">         $&#123;LINK&#125; $latest_mean input_postinf_mean.nc || exit 120</span><br><span class="line">         $&#123;LINK&#125; $latest_sd   input_postinf_sd.nc   || exit 121</span><br><span class="line"></span><br><span class="line">      else if ($CONT_RUN == FALSE) then</span><br><span class="line">         # It&#x27;s the first assimilation; try to find some inflation restart files</span><br><span class="line">         # or make them using fill_inflation_restart.</span><br><span class="line">         # Fill_inflation_restart needs caminput.nc and cam_phis.nc for static_model_init,</span><br><span class="line">         # so this staging is done in assimilate.csh (after a forecast) instead of stage_cesm_files.</span><br><span class="line"></span><br><span class="line">         if (-x $&#123;EXEROOT&#125;/fill_inflation_restart) then</span><br><span class="line">            $&#123;EXEROOT&#125;/fill_inflation_restart</span><br><span class="line">            $&#123;MOVE&#125; prior_inflation_mean.nc input_postinf_mean.nc || exit 125</span><br><span class="line">            $&#123;MOVE&#125; prior_inflation_sd.nc   input_postinf_sd.nc   || exit 126</span><br><span class="line"></span><br><span class="line">         else</span><br><span class="line">            echo &quot;ERROR: Requested POSTERIOR inflation restart for the first cycle.&quot;</span><br><span class="line">            echo &quot;       There are no existing inflation files available &quot;</span><br><span class="line">            echo &quot;       and $&#123;EXEROOT&#125;/fill_inflation_restart is missing.&quot;</span><br><span class="line">            echo &quot;EXITING&quot;</span><br><span class="line">            exit 127</span><br><span class="line">         endif</span><br><span class="line"></span><br><span class="line">      else</span><br><span class="line">         echo &quot;ERROR: Requested POSTERIOR inflation restart, &quot;</span><br><span class="line">         echo &#x27;       but files *.dart.rh.$&#123;scomp&#125;_output_postinf_* do not exist in the $&#123;RUNDIR&#125;.&#x27;</span><br><span class="line">         $&#123;LIST&#125; -l *inf*</span><br><span class="line">         echo &quot;EXITING&quot;</span><br><span class="line">         exit 128</span><br><span class="line">      endif</span><br><span class="line">   endif</span><br><span class="line">else</span><br><span class="line">   echo &quot;Posterior Inflation not requested for this assimilation.&quot;</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">==============================================================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Block 7: Actually run the assimilation.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DART namelist settings required:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&amp;filter_nml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   adv_ens_command         = <span class="string">&quot;no_CESM_advance_script&quot;</span>,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   obs_sequence_in_name    = <span class="string">&#x27;obs_seq.out&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   obs_sequence_out_name   = <span class="string">&#x27;obs_seq.final&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   single_file_in          = .<span class="literal">false</span>.,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   single_file_out         = .<span class="literal">false</span>.,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   stages_to_write         = stages you want + ,<span class="string">&#x27;output&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   input_state_file_list   = <span class="string">&#x27;cam_init_files&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   output_state_file_list  = <span class="string">&#x27;cam_init_files&#x27;</span>,</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># WARNING: the default mode of this script assumes that</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         input_state_file_list = output_state_file_list, so that</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         the CAM initial files used as input to filter will be overwritten.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         The input model states can be preserved by requesting that stage</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">         <span class="string">&#x27;forecast&#x27;</span> be output.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">In the default mode of CAM assimilations, filter gets the model state(s)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">from CAM initial files.  This section puts the names of those files into a text file.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The name of the text file is provided to filter <span class="keyword">in</span> filter_nml:input_state_file_list.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">NOTE:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If the files <span class="keyword">in</span> input_state_file_list are CESM initial files (all vars and</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">all meta data), <span class="keyword">then</span> they will end up with a different structure than</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the non-<span class="string">&#x27;output&#x27;</span>, stage output written by filter (<span class="string">&#x27;preassim&#x27;</span>, <span class="string">&#x27;postassim&#x27;</span>, etc.).</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This can be prevented (at the cost of more disk space) by copying</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the CESM format initial files into the names filter will use <span class="keyword">for</span> preassim, etc.:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   &gt; <span class="built_in">cp</span> <span class="variable">$case</span>.cam_0001.i.<span class="variable">$date</span>.nc  preassim_member_0001.nc.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   &gt; ... <span class="keyword">for</span> all members</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Filter will replace the state variables <span class="keyword">in</span> preassim_member* with updated versions,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">but leave the other variables and all metadata unchanged.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">If filter will create an ensemble from a single state,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   filter_nml: perturb_from_single_instance = .<span class="literal">true</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it<span class="string">&#x27;s fine (and convenient) to put the whole list of files in input_state_file_list.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Filter will just use the first as the base to perturb.</span></span></span><br><span class="line"></span><br><span class="line">set line = `grep input_state_file_list input.nml | sed -e &quot;s#[=,&#x27;\.]# #g&quot;`</span><br><span class="line">set input_file_list_name = $line[2]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If the file names in $output_state_file_list = names in $input_state_file_list,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">then the restart file contents will be overwritten with the states updated by DART.</span></span></span><br><span class="line"></span><br><span class="line">set line = `grep output_state_file_list input.nml | sed -e &quot;s#[=,&#x27;\.]# #g&quot;`</span><br><span class="line">set output_file_list_name = $line[2]</span><br><span class="line"></span><br><span class="line">if ($input_file_list_name != $output_file_list_name) then</span><br><span class="line">   echo &quot;ERROR: assimilate.csh requires that input_file_list = output_file_list&quot;</span><br><span class="line">   echo &quot;       You can probably find the data you want in stage &#x27;forecast&#x27;.&quot;</span><br><span class="line">   echo &quot;       If you truly require separate copies of CAM&#x27;s initial files&quot;</span><br><span class="line">   echo &quot;       before and after the assimilation, see revision 12603, and note that&quot;</span><br><span class="line">   echo &quot;       it requires changing the linking to cam_initial_####.nc, below.&quot;</span><br><span class="line">   exit 130</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;LIST&#125; -1 $&#123;CASE&#125;.cam_[0-9][0-9][0-9][0-9].i.$&#123;ATM_DATE_EXT&#125;.nc &gt;! $input_file_list_name</span></span></span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- BEGIN FILTER&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">## edited by xhw ###</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">change $&#123;LAUNCHCMD&#125; to mpirun -np 64</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">program can stack if too many cores are used</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">64 cores are ok</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$&#123;LAUNCHCMD&#125; $&#123;EXEROOT&#125;/filter || exit 140</span></span></span><br><span class="line">mpirun -np 64 $&#123;EXEROOT&#125;/filter || exit 140</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">##---------------###</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- END FILTER&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Block 8: Rename the output using the CESM file-naming convention.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">If output_state_file_list is filled with custom (CESM) filenames,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">then &#x27;</span>output<span class="string">&#x27; ensemble members will not appear with filter&#x27;</span>s default,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard-wired names.  But file types output_&#123;mean,sd&#125; will appear and be</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">renamed here.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># We don&#x27;t know the exact set of files which will be written,</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">so loop over all possibilities: use LIST <span class="keyword">in</span> the foreach.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">LIST will <span class="built_in">expand</span> the variables and wildcards, only existing files will be</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="keyword">in</span> the foreach loop. (If the input.nml has num_output_state_members = 0,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">there will be no output_member_xxxx.nc even though the <span class="string">&#x27;output&#x27;</span> stage</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">may be requested - <span class="keyword">for</span> the mean and sd)</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Handle files with instance numbers first.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="built_in">split</span> off the .nc</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   separate the pieces of the remainder</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   grab all but the trailing <span class="string">&#x27;member&#x27;</span> and <span class="comment">#### parts.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   and <span class="built_in">join</span> them back together</span></span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- BEGIN FILE RENAMING&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The short-term archiver archives files depending on pieces of their names.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;_####.i.&#x27;</span> files are CESM initial files.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;.dart.i.&#x27;</span> files are ensemble statistics (mean, sd) of just the state variables</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">           <span class="keyword">in</span> the initial files.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;.e.&#x27;</span>      designates a file as something from the <span class="string">&#x27;external system processing ESP&#x27;</span>, e.g. DART.</span></span><br><span class="line"></span><br><span class="line">foreach FILE (`$&#123;LIST&#125; $&#123;stages_all&#125;_member_*.nc`)</span><br><span class="line"></span><br><span class="line">   set parts = `echo $FILE | sed -e &quot;s#\.# #g&quot;`</span><br><span class="line">   set list = `echo $parts[1]  | sed -e &quot;s#_# #g&quot;`</span><br><span class="line">   @ last = $#list - 2</span><br><span class="line">   set dart_file = `echo $list[1-$last] | sed -e &quot;s# #_#g&quot;`</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">DART <span class="string">&#x27;output_member_****.nc&#x27;</span> files are actually linked to cam input files</span></span><br><span class="line"></span><br><span class="line">   set type = &quot;e&quot;</span><br><span class="line">   echo $FILE | grep &quot;put&quot;</span><br><span class="line">   if ($status == 0) set type = &quot;i&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash">&#123;MOVE&#125; <span class="variable">$FILE</span> \</span></span><br><span class="line"><span class="language-bash">       <span class="variable">$&#123;CASE&#125;</span>.<span class="variable">$&#123;scomp&#125;</span>_<span class="variable">$list</span>[<span class="variable">$#list</span>].<span class="variable">$&#123;type&#125;</span>.<span class="variable">$&#123;dart_file&#125;</span>.<span class="variable">$&#123;ATM_DATE_EXT&#125;</span>.nc || <span class="built_in">exit</span> 150</span></span><br><span class="line">end</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Files without instance numbers need to have the scomp part of their names = <span class="string">&quot;dart&quot;</span>.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">This is because <span class="keyword">in</span> st_archive, all files with  scomp = <span class="string">&quot;cam&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(= compname <span class="keyword">in</span> env_archive.xml) will be st_archived using a pattern</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">which</span> has the instance number added onto it.  &#123;mean,sd&#125; files don<span class="string">&#x27;t have</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">instance numbers, so they need to be archived by the &quot;dart&quot; section of env_archive.xml.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">But they still need to be different for each component, so include $scomp in the</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&quot;.dart_file&quot; part of the file name.  Somewhat awkward and inconsistent, but effective.</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Means and standard deviation files (except for inflation).</span></span></span><br><span class="line">foreach FILE (`$&#123;LIST&#125; $&#123;stages_all&#125;_&#123;mean,sd&#125;*.nc`)</span><br><span class="line"></span><br><span class="line">   set parts = `echo $FILE | sed -e &quot;s#\.# #g&quot;`</span><br><span class="line">   set type = &quot;e&quot;</span><br><span class="line">   echo $FILE | grep &quot;put&quot;</span><br><span class="line">   if ($status == 0) set type = &quot;i&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;MOVE&#125; $FILE $&#123;CASE&#125;.dart.$&#123;type&#125;.$&#123;scomp&#125;_$parts[1].$&#123;ATM_DATE_EXT&#125;.nc || exit 160</span></span></span><br><span class="line">end</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Rename the observation file and run-time output</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;MOVE&#125; obs_seq.final $&#123;CASE&#125;.dart.e.$&#123;scomp&#125;_obs_seq_final.$&#123;ATM_DATE_EXT&#125; || exit 170</span></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;MOVE&#125; dart_log.out                 $&#123;scomp&#125;_dart_log.$&#123;ATM_DATE_EXT&#125;.out || exit 171</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Rename the inflation files and designate them as &#x27;</span>rh<span class="string">&#x27; files - which get</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">reinstated in the run directory by the short-term archiver and are then</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">available for the next assimilation cycle.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string"></span></span></span><br><span class="line"><span class="string"><span class="language-bash"># Accommodate any possible inflation files.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">The .$&#123;scomp&#125;_ part is needed by DART to distinguish</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">between inflation files from separate components in coupled assims.</span></span></span><br><span class="line"></span><br><span class="line">foreach FILE (`$&#123;LIST&#125; $&#123;stages_all&#125;_&#123;prior,post&#125;inf_*`)</span><br><span class="line"></span><br><span class="line">   set parts = `echo $FILE | sed -e &quot;s#\.# #g&quot;`</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;MOVE&#125; $FILE  $&#123;CASE&#125;.dart.rh.$&#123;scomp&#125;_$parts[1].$&#123;ATM_DATE_EXT&#125;.nc || exit 180</span></span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Handle localization_diagnostics_files</span></span></span><br><span class="line">set MYSTRING = `grep &#x27;localization_diagnostics_file&#x27; input.nml`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;]# #g&quot;`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &#x27;s#&quot;# #g&#x27;`</span><br><span class="line">set loc_diag = $MYSTRING[2]</span><br><span class="line">if (-f $loc_diag) then</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;MOVE&#125; $loc_diag  $&#123;scomp&#125;_$&#123;loc_diag&#125;.dart.e.$&#123;ATM_DATE_EXT&#125; || exit 190</span></span></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Handle regression diagnostics</span></span></span><br><span class="line">set MYSTRING = `grep &#x27;reg_diagnostics_file&#x27; input.nml`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &quot;s#[=,&#x27;]# #g&quot;`</span><br><span class="line">set MYSTRING = `echo $MYSTRING | sed -e &#x27;s#&quot;# #g&#x27;`</span><br><span class="line">set reg_diag = $MYSTRING[2]</span><br><span class="line">if (-f $reg_diag) then</span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;MOVE&#125; $reg_diag  $&#123;scomp&#125;_$&#123;reg_diag&#125;.dart.e.$&#123;ATM_DATE_EXT&#125; || exit 200</span></span></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Then this script will need to feed the files in output_restart_list_file</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">to the next model advance.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">This gets the .i. or .r. piece from the CESM format file name.</span></span></span><br><span class="line">set line = `grep 0001 $output_file_list_name | sed -e &quot;s#[\.]# #g&quot;`</span><br><span class="line">set l = 1</span><br><span class="line">while ($l &lt; $#line)</span><br><span class="line">   if ($line[$l] =~ $&#123;scomp&#125;_0001) then</span><br><span class="line">      @ l++</span><br><span class="line">      set file_type = $line[$l]</span><br><span class="line">      break</span><br><span class="line">   endif</span><br><span class="line">   @ l++</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">set member = 1</span><br><span class="line">while ( $&#123;member&#125; &lt;= $&#123;ensemble_size&#125; )</span><br><span class="line"></span><br><span class="line">   set inst_string = `printf _%04d $member`</span><br><span class="line">   set ATM_INITIAL_FILENAME = $&#123;CASE&#125;.$&#123;scomp&#125;$&#123;inst_string&#125;.$&#123;file_type&#125;.$&#123;ATM_DATE_EXT&#125;.nc</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;REMOVE&#125; $&#123;scomp&#125;_initial$&#123;inst_string&#125;.nc</span></span></span><br><span class="line"><span class="meta prompt_">   $</span><span class="language-bash"><span class="string">&#123;LINK&#125; $ATM_INITIAL_FILENAME $&#123;scomp&#125;_initial$&#123;inst_string&#125;.nc || exit 210</span></span></span><br><span class="line"></span><br><span class="line">   @ member++</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">echo &quot;`date` -- END   FILE RENAMING&quot;</span><br><span class="line"></span><br><span class="line">if ($cycle == $DATA_ASSIMILATION_CYCLES) then</span><br><span class="line">   echo &quot;`date` -- BEGIN (NON-RESTART) ARCHIVING LOGIC&quot;</span><br><span class="line"></span><br><span class="line">   if ($#log_list &gt;= 3) then</span><br><span class="line"></span><br><span class="line">      # During the last cycle, hide the previous restart set</span><br><span class="line">      # so that it&#x27;s not archived, but is available.</span><br><span class="line">      # (Coupled assimilations may need to keep multiple atmospheric</span><br><span class="line">      #  cycles for each ocean cycle.)</span><br><span class="line"></span><br><span class="line">      set FILE = $re_list[2]</span><br><span class="line">      set FILE = $FILE:r</span><br><span class="line">      if ($FILE:e == &#x27;nc&#x27;) set FILE = $FILE:r</span><br><span class="line">      set hide_date = $FILE:e</span><br><span class="line">      set HIDE_DATE_PARTS = `echo $hide_date | sed -e &quot;s#-# #g&quot;`</span><br><span class="line">      set day_o_month = $HIDE_DATE_PARTS[3]</span><br><span class="line">      set sec_o_day   = $HIDE_DATE_PARTS[4]</span><br><span class="line">      set day_time    = $&#123;day_o_month&#125;-$&#123;sec_o_day&#125;</span><br><span class="line"></span><br><span class="line">      set hidedir = ../Hide_$&#123;day_time&#125;</span><br><span class="line">      mkdir $hidedir</span><br><span class="line"></span><br><span class="line">      if ($save_all_inf =~ TRUE) then</span><br><span class="line">         # Put the previous and current inflation restarts in the archive directory.</span><br><span class="line">         # (to protect last from st_archive putting them in exp/hist)</span><br><span class="line">         $&#123;MOVE&#125;   $&#123;CASE&#125;*$&#123;stages_except_output&#125;*inf*  $&#123;archive&#125;/esp/rest</span><br><span class="line"></span><br><span class="line">         # Don&#x27;t need previous inf restarts now, but want them to be archived later.</span><br><span class="line">         # COPY instead of LINK because they&#x27;ll be moved or used later.</span><br><span class="line">         $&#123;COPY&#125;   $&#123;CASE&#125;*output*inf* $&#123;archive&#125;/esp/rest</span><br><span class="line">      else</span><br><span class="line">         # output*inf must be copied back because it needs to be in $&#123;RUNDIR&#125;</span><br><span class="line">         # when st_archive runs to save the results of the following assim</span><br><span class="line">         $&#123;MOVE&#125;   $&#123;CASE&#125;*inf*$&#123;day_time&#125;*  $hidedir</span><br><span class="line"></span><br><span class="line">         # Don&#x27;t need previous inf restarts now, but want them to be archived later.</span><br><span class="line">         $&#123;COPY&#125;   $hidedir/$&#123;CASE&#125;*output*inf*$&#123;day_time&#125;* .</span><br><span class="line">      endif</span><br><span class="line"></span><br><span class="line">      # Hide the CAM &#x27;restart&#x27; files from the previous cycle (day_time) from the archiver.</span><br><span class="line">      ### edited by xhw ###</span><br><span class="line">      # change $&#123;MOVE&#125; to $&#123;COPY&#125;</span><br><span class="line">      # $&#123;MOVE&#125; will make us lose our historical files</span><br><span class="line">      # $&#123;MOVE&#125;           $&#123;CASE&#125;*.&#123;r,rs,rs1,rh0,h0,i&#125;.*$&#123;day_time&#125;* </span><br><span class="line">      $&#123;COPY&#125;           $&#123;CASE&#125;*.&#123;r,rs,rs1,rh0,h0,i&#125;.*$&#123;day_time&#125;*    $hidedir</span><br><span class="line">      ###---------------###</span><br><span class="line"></span><br><span class="line">      # Move log files: *YYMMDD-HHMMSS.  [2] means the previous restart set is being moved.</span><br><span class="line">      set rm_log = `echo $log_list[2] | sed -e &quot;s/\./ /g;&quot;`</span><br><span class="line">      # -- (decrement by one) skips the gz at the end of the names.</span><br><span class="line">      set rm_slot = $#rm_log</span><br><span class="line">      if ($rm_log[$#rm_log] =~ gz) @ rm_slot--</span><br><span class="line">      $&#123;MOVE&#125;  *$rm_log[$rm_slot]*  $hidedir</span><br><span class="line">   endif</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Restore CESM&#x27;</span>s timing logic <span class="keyword">for</span> the first cycle of the next job.</span></span><br><span class="line">   cd $&#123;CASEROOT&#125;</span><br><span class="line">   ./xmlchange CHECK_TIMING=$&#123;CHECK_TIMING&#125;</span><br><span class="line">   cd $&#123;RUNDIR&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">Create a netCDF file <span class="built_in">which</span> contains the names of DART inflation restart files.</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">This is needed <span class="keyword">in</span> order to use the CESM st_archive mechanisms <span class="keyword">for</span> keeping,</span> </span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="keyword">in</span> <span class="variable">$RUNDIR</span>, <span class="built_in">history</span> files <span class="built_in">which</span> are needed <span class="keyword">for</span> restarts.</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">These special files must be labeled with <span class="string">&#x27;.rh.&#x27;</span>.</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">St_archive looks <span class="keyword">in</span> a .r. restart file <span class="keyword">for</span> the names of these <span class="string">&#x27;restart history&#x27;</span> files.</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">DART<span class="string">&#x27;s inflation files fit the definition of restart history files, so we put .rh.</span></span> </span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">in their names.  Those file names must be found in a dart.r. file, which is created here.</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Inflation restart file names for all components will be in this one restart file,</span></span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">since the inflation restart files have the component names in them.</span></span></span><br><span class="line"></span><br><span class="line">   set inf_list = `ls *output_&#123;prior,post&#125;inf_*.$&#123;ATM_DATE_EXT&#125;.nc`</span><br><span class="line">   set file_list = &#x27;restart_hist = &quot;./&#x27;$inf_list[1]\&quot;</span><br><span class="line">   set i = 2</span><br><span class="line">   while ($i &lt;= $#inf_list)</span><br><span class="line">      set file_list = ($&#123;file_list&#125;\, \&quot;./$inf_list[$i]\&quot;)</span><br><span class="line">      @ i++</span><br><span class="line">   end</span><br><span class="line">   cat &lt;&lt; ___EndOfText &gt;! inf_restart_list.cdl</span><br><span class="line">       netcdf template &#123;  // CDL file which ncgen will use to make a DART restart file</span><br><span class="line">                          // containing just the names of the needed inflation restart files.</span><br><span class="line">       dimensions:</span><br><span class="line">            num_files = $#inf_list;</span><br><span class="line">       variables:</span><br><span class="line">            string  restart_hist(num_files);</span><br><span class="line">            restart_hist:long_name = &quot;DART restart history file names&quot;;</span><br><span class="line">       data:</span><br><span class="line">            $file_list;</span><br><span class="line">       &#125;</span><br><span class="line">___EndOfText</span><br><span class="line"></span><br><span class="line">   ncgen -k netCDF-4 -o $&#123;CASE&#125;.dart.r.$&#123;scomp&#125;.$&#123;ATM_DATE_EXT&#125;.nc inf_restart_list.cdl</span><br><span class="line">   if ($status == 0) $&#123;REMOVE&#125; inf_restart_list.cdl</span><br><span class="line"></span><br><span class="line">   echo &quot;`date` -- END   ARCHIVING LOGIC&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">DEBUG st_archive by making a shadow copy of this directory.</span></span></span><br><span class="line">   module load nco</span><br><span class="line"></span><br><span class="line">   if (-d ../run_shadow) $&#123;REMOVE&#125; -f ../run_shadow</span><br><span class="line">   mkdir ../run_shadow</span><br><span class="line"></span><br><span class="line">   set comps = (&#x27;cam_&#x27;  &#x27;clm2_&#x27;  &#x27;mosart_&#x27; &#x27;dart&#x27;)</span><br><span class="line">   set vars  = (&#x27;nhfil&#x27; &#x27;locfnh&#x27; &#x27;locfnh&#x27;  &#x27;restart_hist&#x27;)</span><br><span class="line"></span><br><span class="line">   foreach f (`$LIST[1]`)</span><br><span class="line">      set gr_stat = 1</span><br><span class="line">      echo $f | grep &#x27;\.r\.&#x27;</span><br><span class="line">      if ($status == 0) then</span><br><span class="line">         set c = 1</span><br><span class="line">         while ($c &lt;= $#comps) </span><br><span class="line">            echo $f | grep $comps[$c]</span><br><span class="line">            if ($status == 0) then</span><br><span class="line">               echo &quot;c = $c for $f&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">               set echo verbose</span></span></span><br><span class="line">               set gr_stat = 0</span><br><span class="line">               ncks -O -v $vars[$c] $f ../run_shadow/$f</span><br><span class="line">               break</span><br><span class="line">            endif</span><br><span class="line">            @ c++</span><br><span class="line">         end</span><br><span class="line">      endif</span><br><span class="line">      if ($gr_stat == 1) then</span><br><span class="line">         $&#123;LIST&#125; -l $f &gt;! ../run_shadow/$f</span><br><span class="line">      endif</span><br><span class="line">   end</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Compress the large coupler history files and DART files.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">==============================================================================</span></span></span><br><span class="line"></span><br><span class="line">echo &quot;STARTING: compressing coupler history files and DART files at `date`&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;CASEROOT&#125;/compress.csh $CASE $ATM_DATE_EXT $ensemble_size &quot;hist dart&quot; &quot;$stages_all&quot;</span></span></span><br><span class="line">if ($status != 0) then</span><br><span class="line">   echo &quot;ERROR: Compression of coupler history files and DART files failed at `date`&quot;</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">Ensure the removal of unneeded restart sets and copy of obs_seq.final are finished.</span></span></span><br><span class="line">   wait</span><br><span class="line">   exit 250</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">echo &quot;FINISHED: compressing coupler history files and DART files at `date`&quot;</span><br><span class="line">echo &quot;`date` -- END CAM_ASSIMILATE&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Ensure the removal of unneeded restart sets and copy of obs_seq.final are finished.</span></span></span><br><span class="line">wait</span><br><span class="line"></span><br><span class="line">exit 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&lt;next few lines under version control, do not edit&gt;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$URL$</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$Revision$</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">$Date$</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="compress-csh">compress.csh</h2>
<p><code>compress.csh</code>是 <code>assimilation.csh</code>自动调用的程序。作用是对DART生成的文件进行压缩打包，方便后面归档。 但存在一下小bug需要修改</p>
<p>在171行做如下修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">foreach <span class="built_in">type</span> ( ha2x1d hr2x ha2x3h ha2x1h ha2x1hi )</span></span><br><span class="line">foreach type (hr2x ha2x3h ha2x1h ha2x1hi )</span><br></pre></td></tr></table></figure>
<p>这一行中hr2x ha2x3h ha2x1h ha2x1hi是cpl输出的，需要在<code>user_nl_cpl</code>中加入</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">histaux_a2x1hr = .true.</span><br><span class="line">histaux_a2x3hr = .true.</span><br><span class="line">histaux_a2x1hri = .true.</span><br><span class="line">histaux_a2x24hr = .true.</span><br><span class="line">histaux_r2x = .true.</span><br></pre></td></tr></table></figure>
<p><code>ha2x1d</code> 似乎并不在cesm2.1.x中出现，我把他去掉了，似乎没有什么影响。</p>
<p>在压缩打包hr2x ha2x3h ha2x1h ha2x1hi等文件时，会先搜索他们的完整文件名。程序认为他们的文件名是以年-月-日-秒.nc结尾的。但时间上输出的是年-月-日.nc结尾的。这样程序就找不到这些文件，因而报错。这里通过重命名为年-月-日-秒.nc的方式解决。</p>
<p>在 <code>while ( $i &lt;= $ensemble_size)</code> 后做如下修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> lastfilename = `<span class="built_in">printf</span> <span class="string">&quot;%s.cpl_%04d.%s.%s.nc%s&quot;</span> <span class="variable">$case_name</span> <span class="variable">$i</span> <span class="variable">$type</span> <span class="variable">$ymds</span> <span class="variable">$ext</span>`</span></span><br><span class="line"></span><br><span class="line">set ymd_self = `echo $ymds | cut -d&#x27;-&#x27; -f1-3`</span><br><span class="line">set lastfilename = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymd_self $ext`</span><br><span class="line">set newfilename = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymds $ext`</span><br><span class="line">mv $lastfilename $newfilename</span><br></pre></td></tr></table></figure>
<p>另一处修改， 本系统找不到mpiexec_mpt，直接sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($task &gt; 0) then</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">mpiexec_mpt -n <span class="variable">$task</span> launch_cf.sh ./mycmdfile</span></span><br><span class="line">   sh ./mycmdfile</span><br></pre></td></tr></table></figure>
<p>还有一些其他修改，下面也贴出完整的compress.csh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/tcsh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DART software - Copyright UCAR. This open source software is provided</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">by UCAR, <span class="string">&quot;as is&quot;</span>, without charge, subject to all terms of use at</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://www.image.ucar.edu/DAReS/DART/DART_download</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#PBS  -N compress.csh</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -A P86850054</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -q premium</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For restarts:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="comment">#PBS  -l select=9:ncpus=36:mpiprocs=36</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For hist: 6 * 80         = 480</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For dart: 1 + 2*(2 + 80) = 165</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">                           645 / 36 = 18</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For rest: 4 * 80         = 320 / 36 =  9</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -l select=18:ncpus=36:mpiprocs=36</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -l walltime=00:20:00</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -o compress.out</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">PBS  -j oe</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Purpose:</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># compresses or uncompresses sets of files from a forecast or assimilation.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ------------------------------------------------------------------------------</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Method:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># When called from a script (normally assimilate.csh), it compresses the files.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">When submitted as a batch job, it can also uncompress sets of files -</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IF this script has been configured to use the right metadata to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">construct the expected data directories.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># The strategy is to create a cmdfile that contains a separate task on each line</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and dispatch that cmdfile to perform N simultaneous operations. That cmdfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">has a syntax ( &amp;&gt; ) to put stderr and stdout <span class="keyword">in</span> a single file.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PBS requires <span class="string">&#x27;setenv MPI_SHEPHERD true&#x27;</span> <span class="keyword">for</span> the cmdfile to work correctly.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Compression method can depend on the file type, and in the future may include</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lossy compression. This script is most often called by assimilate.csh, but can</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">be run as a batch job.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Assimilate.csh runs this in 2 places:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1) Every cycle:</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   +  all the cpl <span class="built_in">history</span> (forcing) files.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   +  DART output</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &gt;  stages of state files</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">            mean, sd  (no instance number)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &gt;  obs_seq.final (no instance number)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &gt;  Note: inflation files are never compressed.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2) Before archiving a restart <span class="built_in">set</span> to archive/rest; all large restart files.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">if ($#argv == 5) then</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">Called from assimilate.csh (or other script).</span></span><br><span class="line">   set comp_cmd      = &#x27;gzip&#x27;</span><br><span class="line">   set case_name     = $1</span><br><span class="line">   set ymds          = $2</span><br><span class="line">   set ensemble_size = $3</span><br><span class="line">   set sets          = ($4)</span><br><span class="line">   set stages        = ($5)</span><br><span class="line">   set data_dir      = &#x27;.&#x27;</span><br><span class="line"></span><br><span class="line">else if ($#argv == 0) then</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">Edit these and run as a batch job.</span></span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="string">&#x27;sets&#x27;</span> performs better when ordered by decreasing size (clm2 cpl cam cice hist dart)</span></span><br><span class="line">   set comp_cmd      = &#x27;gunzip&#x27;</span><br><span class="line">   set case_name     = CESM2_1_80_3node</span><br><span class="line">   set ymds          = 2010-07-17-64800</span><br><span class="line">   set ensemble_size = 80</span><br><span class="line">   set sets          = (hist dart)</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="built_in">set</span> sets          = (clm2 cpl cam cice)</span></span><br><span class="line">   set stages        = (preassim output)</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash"><span class="built_in">set</span> data_dir      = /glade/scratch/<span class="variable">$&#123;USER&#125;</span>/<span class="variable">$&#123;case_name&#125;</span>/archive/rest/<span class="variable">$&#123;ymds&#125;</span></span></span><br><span class="line">   set data_dir      = /glade/scratch/$&#123;USER&#125;/$&#123;case_name&#125;/run</span><br><span class="line"></span><br><span class="line">else </span><br><span class="line">   echo &quot;Usage: call with exactly 5 arguments or submit as a batch job with 0 arguments:&quot;</span><br><span class="line">   echo &#x27;   $&#123;scr_dir&#125;/compress.csh case_name YYYY-MM-DD-SSSS ensemble_size &quot;sets&quot; &quot;stages&quot;&#x27;</span><br><span class="line">   echo &#x27;   where &#x27;</span><br><span class="line">   echo &#x27;   sets   = 1 or more of &#123;clm2 cpl cam cice hist dart&#125; to compress, separated by spaces&#x27;</span><br><span class="line">   echo &#x27;   stages = 1 or more of stages &#123;input, preassim, postassim, output&#125; to compress.&#x27;</span><br><span class="line">   echo &#x27; -OR-&#x27;</span><br><span class="line">   echo &quot;   edit compress.csh ; qsub compress.csh&quot;</span><br><span class="line">   exit 17</span><br><span class="line"></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">set cmd = `echo $comp_cmd | cut -d&#x27; &#x27; -f1`</span><br><span class="line">if ($cmd == &#x27;gzip&#x27;) then</span><br><span class="line">   set ext = &#x27;&#x27;</span><br><span class="line">else if ($cmd == &#x27;gunzip&#x27;) then</span><br><span class="line">   set ext = &#x27;.gz&#x27;</span><br><span class="line">else</span><br><span class="line">   echo &quot;ERROR: unrecognized command $cmd.  Don&#x27;t know which extension to use&quot;</span><br><span class="line">   exit 27</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">echo &quot;In compress.csh:&quot;</span><br><span class="line">echo &quot;   comp_cmd      = $comp_cmd&quot;</span><br><span class="line">echo &quot;   case_name     = $case_name&quot;</span><br><span class="line">echo &quot;   date          = $ymds&quot;</span><br><span class="line">echo &quot;   ensemble_size = $ensemble_size&quot;</span><br><span class="line">echo &quot;   sets          = $sets&quot;</span><br><span class="line">echo &quot;   stages        = $stages&quot;</span><br><span class="line">echo &quot;   data dir      = $data_dir&quot;</span><br><span class="line"></span><br><span class="line">cd $data_dir</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fail <span class="keyword">if</span> there are leftover error logs from previous compression.csh executions.</span></span><br><span class="line"></span><br><span class="line">ls *.eo &gt; /dev/null</span><br><span class="line">if ($status == 0) then</span><br><span class="line">   echo &quot;ERROR; Existing compression log files: *.eo.  Exiting&quot;</span><br><span class="line">   exit 37</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Environment and commands.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setenv MPI_SHEPHERD true</span><br><span class="line"></span><br><span class="line">setenv date &#x27;date --rfc-3339=ns&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Create the <span class="built_in">command</span> file <span class="built_in">where</span> each line is a separate <span class="built_in">command</span>, task, operation, ....</span></span><br><span class="line"></span><br><span class="line">\rm -f mycmdfile</span><br><span class="line">touch mycmdfile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;task&#x27;</span> is incremented continuously over all files; components, members, etc.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;task&#x27;</span> is a running counter of <span class="built_in">jobs</span> <span class="keyword">in</span> mycmdfile.</span></span><br><span class="line">set task = 0</span><br><span class="line"></span><br><span class="line">foreach comp ( $sets )</span><br><span class="line">echo &quot;comp = $comp&quot;</span><br><span class="line">switch ($comp)</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">FIXME ... the coupler files may or may not have an instance number <span class="keyword">in</span> them.</span></span><br><span class="line">   case &#123;clm2,cpl,cam,cice&#125;:</span><br><span class="line">      set i=1</span><br><span class="line">      while ( $i &lt;= $ensemble_size)</span><br><span class="line">         # E.g. CAM6_80mem.cice_0001.r.2010-07-15-00000.nc</span><br><span class="line">         set file_name = `printf &quot;%s.%s_%04d.r.%s.nc%s&quot; $case_name $comp $i $ymds $ext`</span><br><span class="line">         # echo &quot;   $file_name&quot;</span><br><span class="line">   </span><br><span class="line">         # If the expected file exists, add the compression command </span><br><span class="line">         if (-f $file_name) then</span><br><span class="line">            @ task++</span><br><span class="line">            echo &quot;$comp_cmd $file_name &amp;&gt; compress_$&#123;task&#125;.eo &quot; &gt;&gt; mycmdfile</span><br><span class="line">         # Kluge to get around situations where an earlier job compressed the file,</span><br><span class="line">         # but failed for some other reason, so it&#x27;s being re-run.</span><br><span class="line">         else if (-f $&#123;file_name&#125;.gz) then</span><br><span class="line">            echo &quot;$file_name already compressed&quot;</span><br><span class="line">         else</span><br><span class="line">            echo &#x27;ERROR: Could not find &quot;&#x27;$file_name&#x27;&quot; to compress.&#x27;</span><br><span class="line">            exit 47</span><br><span class="line">         endif</span><br><span class="line"></span><br><span class="line">         @ i++</span><br><span class="line">      end</span><br><span class="line">      breaksw</span><br><span class="line"></span><br><span class="line">   case hist:</span><br><span class="line">      # Coupler history (forcing) files, ordered by decreasing size </span><br><span class="line">      # ha is not a necessary forcing file.  The others can do the job</span><br><span class="line">      # and are much smaller.</span><br><span class="line">      # foreach type ( ha2x1d hr2x ha2x3h ha2x1h ha2x1hi )</span><br><span class="line">      foreach type (hr2x ha2x3h ha2x1h ha2x1hi )</span><br><span class="line"></span><br><span class="line">         # Loop over instance number</span><br><span class="line">         set i=1</span><br><span class="line">         while ( $i &lt;= $ensemble_size)</span><br><span class="line">            # E.g. CAM6_80mem.cpl_0001.ha.2010-07-15-00000.nc</span><br><span class="line">            # set lastfilename = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymds $ext`</span><br><span class="line">            #</span><br><span class="line">            set ymd_self = `echo $ymds | cut -d&#x27;-&#x27; -f1-3`</span><br><span class="line">            set lastfilename = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymd_self $ext`</span><br><span class="line">	    set newfilename = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymds $ext`</span><br><span class="line">            mv $lastfilename $newfilename</span><br><span class="line"> </span><br><span class="line">            set file_name = `printf &quot;%s.cpl_%04d.%s.%s.nc%s&quot; $case_name $i $type $ymds $ext`</span><br><span class="line">      </span><br><span class="line">            if (-f $file_name) then</span><br><span class="line">               @ task++</span><br><span class="line">                  echo &quot;$comp_cmd $file_name &amp;&gt; compress_$&#123;task&#125;.eo&quot; &gt;&gt; mycmdfile</span><br><span class="line">            else if (-f $&#123;file_name&#125;.gz) then</span><br><span class="line">               echo &quot;$file_name already compressed&quot;</span><br><span class="line">            else</span><br><span class="line">               echo &#x27;ERROR: Could not find &quot;&#x27;$file_name&#x27;&quot; to compress.&#x27;</span><br><span class="line">               echo &quot;exit is prevented by xhw&quot; </span><br><span class="line">	       # exit 57</span><br><span class="line">            endif</span><br><span class="line"></span><br><span class="line">            @ i++</span><br><span class="line">         end</span><br><span class="line">      end</span><br><span class="line">      breaksw</span><br><span class="line"></span><br><span class="line">   case dart:</span><br><span class="line">      # It is not worthwhile to compress inflation files ... small, not many files</span><br><span class="line">      # It is also not clear that binary observation sequence files compress effectively.</span><br><span class="line"></span><br><span class="line">      # obs_seq.final (no inst)   70% of 1 Gb (ascii) in 35 sec</span><br><span class="line">      # E.g. CAM6_80mem.dart.e.cam_obs_seq_final.2010-07-15-00000</span><br><span class="line">      set file_name = $&#123;case_name&#125;.dart.e.cam_obs_seq_final.$&#123;ymds&#125;$&#123;ext&#125;</span><br><span class="line">      if (-f $file_name) then</span><br><span class="line">         @ task++</span><br><span class="line">         echo &quot;$comp_cmd $file_name &amp;&gt; compress_$&#123;task&#125;.eo&quot; &gt;&gt; mycmdfile</span><br><span class="line">      endif</span><br><span class="line"></span><br><span class="line">      foreach stage ($stages)</span><br><span class="line">         foreach stat ( &#x27;mean&#x27; &#x27;sd&#x27; )</span><br><span class="line">            # E.g. CAM6_80mem.e.cam_output_mean.2010-07-15-00000.nc</span><br><span class="line">            # E.g. CAM6_80mem.e.cam_output_sd.2010-07-15-00000.nc</span><br><span class="line">            set file_name = $&#123;case_name&#125;.dart.e.cam_$&#123;stage&#125;_$&#123;stat&#125;.$&#123;ymds&#125;.nc$&#123;ext&#125;</span><br><span class="line">            if (-f $file_name) then</span><br><span class="line">               @ task++</span><br><span class="line">               echo &quot;$comp_cmd $file_name &amp;&gt; compress_$&#123;task&#125;.eo&quot; &gt;&gt; mycmdfile</span><br><span class="line">            endif</span><br><span class="line">         end</span><br><span class="line"></span><br><span class="line">         # Loop over instance number</span><br><span class="line">         set i=1</span><br><span class="line">         while ( $i &lt;= $ensemble_size)</span><br><span class="line">            # E.g. CAM6_80mem.cam_0001.e.preassim.2010-07-15-00000.nc</span><br><span class="line">            set file_name = `printf &quot;%s.cam_%04d.e.%s.%s.nc%s&quot; $case_name $i $stage $ymds $ext`</span><br><span class="line">            if (-f $file_name) then</span><br><span class="line">               @ task++</span><br><span class="line">               echo &quot;$comp_cmd $file_name &amp;&gt; compress_$&#123;task&#125;.eo&quot; &gt;&gt; mycmdfile</span><br><span class="line">            endif</span><br><span class="line">            @ i++</span><br><span class="line">         end</span><br><span class="line">      end</span><br><span class="line">      breaksw</span><br><span class="line">      </span><br><span class="line">   default:</span><br><span class="line">      breaksw</span><br><span class="line">endsw</span><br><span class="line">end</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">echo &quot;Before launching mycmdfile&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">date</span></span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CHECKME ... make sure <span class="variable">$task</span> is &lt;= the number of MPI tasks <span class="keyword">in</span> this job.</span></span><br><span class="line"></span><br><span class="line">if ($task &gt; 0) then</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">mpiexec_mpt -n <span class="variable">$task</span> launch_cf.sh ./mycmdfile</span></span><br><span class="line">   sh ./mycmdfile</span><br><span class="line"></span><br><span class="line">   set mpt_status = $status</span><br><span class="line">   echo &quot;mpt_status = $mpt_status&quot;</span><br><span class="line">else</span><br><span class="line">   echo &quot;No compression to do&quot;</span><br><span class="line">   exit 0</span><br><span class="line">endif</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Check the statuses?</span></span><br><span class="line">if ( -f compress_1.eo ) then</span><br><span class="line">   grep $cmd *.eo</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">grep failure = compression success = <span class="string">&quot;not 0&quot;</span></span></span><br><span class="line">   set gr_stat = $status</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="built_in">echo</span> <span class="string">&quot;gr_stat when eo file exists = <span class="variable">$gr_stat</span>&quot;</span></span></span><br><span class="line">else</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">No eo files = failure of something besides g(un)zip.</span></span><br><span class="line">   set gr_stat = 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   <span class="built_in">echo</span> <span class="string">&quot;gr_stat when eo file does not exist = <span class="variable">$gr_stat</span>&quot;</span></span></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">if ($gr_stat == 0) then</span><br><span class="line">   echo &quot;compression failed.  See .eo files with non-0 sizes&quot;</span><br><span class="line">   echo &quot;Remove .eo files after failure is resolved.&quot;</span><br><span class="line">   exit 197</span><br><span class="line">else</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">Compression worked; clean up the .eo files and mycmdfile</span></span><br><span class="line">   \rm -f *.eo  mycmdfile</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">exit 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="关于FWSD和FWHIST">关于FWSD和FWHIST</h2>
<p>DART目前无法对有ism(冰川)模块的compset进行同化。在创建FWSD时，默认是没有冰川<code>COMP_GLC: sglc</code> 。 因此FWSD是可以直接用DART的。但是如果不希望有nudging，一种方法是把FWSD里的max_rlx_bottom和max_rlx_top调低，例如max_rlx_bottom=1， max_rlx_top=2 (最好不要设成零点几，会出错)。 这样相对于几乎没有进行nudge。</p>
<p>另一种只能创建FWHIST， 但FWHIST默认的冰川是cism。 我目前不会调整compset的组合。所以这个暂时没法用FWHIST。</p>
<p>在用FWSD时，需要频繁地修改met_data。 例如我从2012-12-01-00000开始运行，met_data时间戳是2012-12-01。 如果程序运行至2012-12-02，那么模式会自己找到对应的met_data没问题。 如果运行到了2012-12-03，那么会出现模式就找不到met_data了。这时需要手动（或在assimition.csh里添加脚本），将user_nl_cam里的met_data修改为2012-12-03。 也就是说模式只能找到两天内正确的met_data。</p>
<p>一般DART的工作流程是这样的。 先运行6小时，然后停下运行assimilation。接着再运行六小时以此类推。 由于模式只能找到两天内的正确的met_data, 应该设置<code>./xmlchange DATA_ASSIMILATION_CYCLES=8</code>, 然后设置RESUBMIT为任意值。</p>
<h2 id="观测数据">观测数据</h2>
<p>如果我们从2012-12-01-00000运行6小时到2012-12-01-21600, 这时DART就启动同化。 它会在以2012-12-01-21600为中心的6个小时内，即(2012-12-01-10800, 2012-12-01-32400]内寻找观测数据。</p>
<p>我所试验的同化数据是Aura MLS temperature Level2, 下载地址为<a target="_blank" rel="noopener" href="https://disc.gsfc.nasa.gov/datasets?keywords=MLS&amp;page=1">GES DISC Search: Showing 1 - 25 of 179 datasets associated with MLS (nasa.gov)</a>。</p>
<p>我们首先需要将他处理为nc格式， 处理python程序如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#%%</span></span><br><span class="line"><span class="keyword">import</span> h5py</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> netCDF4 <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">import</span> xarray <span class="keyword">as</span> xr</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># %%  xarray</span></span><br><span class="line">filelist = glob.glob(<span class="string">&#x27;/data2/share/elzd_2024_000125/xhw/downloadData/MLS/2013/Level2/MLS*&#x27;</span>)</span><br><span class="line">filelist = <span class="built_in">sorted</span>(filelist)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(filelist)):</span><br><span class="line">    f = h5py.File(filelist[i], mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    f.visit(<span class="keyword">lambda</span> x: <span class="built_in">print</span>(x))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    T = f[<span class="string">&#x27;HDFEOS/SWATHS/Temperature/Data Fields/L2gpValue&#x27;</span>][:]</span><br><span class="line">    datafield = <span class="string">&#x27;/HDFEOS/SWATHS/Temperature/Data Fields/&#x27;</span></span><br><span class="line">    geofield = <span class="string">&#x27;/HDFEOS/SWATHS/Temperature/Geolocation Fields/&#x27;</span></span><br><span class="line">    pres_path = <span class="string">&#x27;/HDFEOS/SWATHS/Temperature/Geolocation Fields/Pressure&#x27;</span></span><br><span class="line">    lat_path = <span class="string">&#x27;/HDFEOS/SWATHS/Temperature/Geolocation Fields/Latitude&#x27;</span></span><br><span class="line">    lon_path = <span class="string">&#x27;/HDFEOS/SWATHS/Temperature/Geolocation Fields/Longitude&#x27;</span></span><br><span class="line">    time_path = <span class="string">&#x27;HDFEOS/SWATHS/Temperature/Geolocation Fields/Time&#x27;</span></span><br><span class="line"></span><br><span class="line">    longitude = f[lon_path][:]</span><br><span class="line">    latitude = f[lat_path][:]</span><br><span class="line">    timeMLS = f[time_path][:]</span><br><span class="line">    level = f[pres_path][:]</span><br><span class="line">    Precision = f[datafield+<span class="string">&#x27;L2gpPrecision&#x27;</span>][:]</span><br><span class="line">    Quality = f[datafield+<span class="string">&#x27;Quality&#x27;</span>][:]</span><br><span class="line">    Convergence = f[datafield+<span class="string">&#x27;Convergence&#x27;</span>][:]</span><br><span class="line">    LocalSolarTime = f[geofield+<span class="string">&#x27;LocalSolarTime&#x27;</span>][:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    time = np.datetime64(<span class="string">&#x27;1993-01-01T00&#x27;</span>) + f[time_path][:].astype(<span class="string">&#x27;timedelta64[s]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># dfall = xr.DataArray(T, coords=&#123;&#x27;time&#x27;:time, &#x27;level&#x27;:level, &#x27;longitude&#x27;:(&#x27;time&#x27;, longitude), &#x27;latitude&#x27;:(&#x27;time&#x27;, latitude)&#125;, dims=[&#x27;time&#x27;, &#x27;level&#x27;])</span></span><br><span class="line">    T = xr.DataArray(T, coords=&#123;<span class="string">&#x27;times&#x27;</span>: (<span class="string">&#x27;times&#x27;</span>,time), <span class="string">&#x27;levels&#x27;</span>:(<span class="string">&#x27;levels&#x27;</span>,level)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>, <span class="string">&#x27;levels&#x27;</span>], name=<span class="string">&#x27;Temperature&#x27;</span>)</span><br><span class="line">    Pressure = xr.DataArray(level, coords=&#123;<span class="string">&#x27;levels&#x27;</span>:(<span class="string">&#x27;levels&#x27;</span>,level)&#125;, dims=[<span class="string">&#x27;levels&#x27;</span>], name=<span class="string">&#x27;Pressure&#x27;</span>)</span><br><span class="line">    Longitude = xr.DataArray(longitude, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;Longitude&#x27;</span>)</span><br><span class="line">    Latitude = xr.DataArray(latitude, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;Latitude&#x27;</span>)</span><br><span class="line">    Precision = xr.DataArray(Precision, coords=&#123;<span class="string">&#x27;times&#x27;</span>: (<span class="string">&#x27;times&#x27;</span>,time), <span class="string">&#x27;levels&#x27;</span>:(<span class="string">&#x27;levels&#x27;</span>,level)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>, <span class="string">&#x27;levels&#x27;</span>], name=<span class="string">&#x27;Precision&#x27;</span>)</span><br><span class="line">    Quality = xr.DataArray(Quality, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;Quality&#x27;</span>)</span><br><span class="line">    Convergence = xr.DataArray(Convergence, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;Convergence&#x27;</span>)</span><br><span class="line">    LocalSolarTime = xr.DataArray(LocalSolarTime, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;LocalSolarTime&#x27;</span>)</span><br><span class="line">    Time = xr.DataArray(time, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;Time&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    DAYOFYEAR = Time.times.dt.dayofyear.values</span><br><span class="line">    DAYOFYEAR = xr.DataArray(DAYOFYEAR, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;DAYOFYEAR&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    YEAR = Time.times.dt.year.values</span><br><span class="line">    YEAR = xr.DataArray(YEAR, coords=&#123;<span class="string">&#x27;times&#x27;</span>:(<span class="string">&#x27;times&#x27;</span>,time)&#125;, dims=[<span class="string">&#x27;times&#x27;</span>], name=<span class="string">&#x27;YEAR&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        dsall = xr.merge([Time, Pressure, Latitude, Longitude, LocalSolarTime, T, Precision, Quality, Convergence, DAYOFYEAR, YEAR])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ds = xr.merge([Time, Pressure, Latitude, Longitude, LocalSolarTime, T, Precision, Quality, Convergence, DAYOFYEAR, YEAR])</span><br><span class="line">        </span><br><span class="line">        dsall = xr.concat([dsall, ds], dim=<span class="string">&#x27;times&#x27;</span>)</span><br><span class="line"><span class="comment"># %%</span></span><br><span class="line"></span><br><span class="line">timename =  pd.date_range(<span class="string">&#x27;2012-12-01-00&#x27;</span>,<span class="string">&#x27;2013-01-25&#x27;</span>, freq=<span class="string">&#x27;6H&#x27;</span>)</span><br><span class="line">dsall.sel(times=<span class="string">&#x27;2012-12-03&#x27;</span>)</span><br><span class="line"><span class="comment"># i = 20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(timename.shape[<span class="number">0</span>]-<span class="number">1</span>):</span><br><span class="line">    </span><br><span class="line">    left = timename[i] - np.timedelta64(<span class="number">3</span>,<span class="string">&#x27;h&#x27;</span>)</span><br><span class="line">    right = timename[i] + np.timedelta64(<span class="number">3</span>,<span class="string">&#x27;h&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    ds_temp = dsall.sel(times =<span class="built_in">slice</span>((left+np.timedelta64(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>)).strftime(<span class="string">&#x27;%Y-%m-%dT%H:%S&#x27;</span>), </span><br><span class="line">                                     (right-np.timedelta64(<span class="number">1</span>,<span class="string">&#x27;s&#x27;</span>)).strftime(<span class="string">&#x27;%Y-%m-%dT%H:%S&#x27;</span>)</span><br><span class="line">                                     ))</span><br><span class="line">    ds_temp[<span class="string">&#x27;times&#x27;</span>] = (ds_temp.times.values -  np.datetime64(<span class="string">&#x27;1993-01-01T00&#x27;</span>)).astype(<span class="string">&#x27;timedelta64[s]&#x27;</span>).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">    secondofday = timename[i].hour * <span class="number">3600</span></span><br><span class="line">    secondofday = <span class="string">&quot;&#123;:0&lt;5d&#125;&quot;</span>.<span class="built_in">format</span>(secondofday)</span><br><span class="line">    day = timename[i].strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fileout_path = <span class="string">&#x27;/data2/share/elzd_2024_000125/xhw/downloadData/MLS/2013/Level2/DART_nc/201212_6H_CESM&#x27;</span></span><br><span class="line">    ds_temp.to_netcdf(<span class="string">f&#x27;<span class="subst">&#123;fileout_path&#125;</span>/<span class="subst">&#123;day&#125;</span>-<span class="subst">&#123;secondofday&#125;</span>.nc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上程序会将MLS数据每6小时存为一个nc文件。接着使用DART自带的转换工具，将nc文件转换为DART能够读懂的文本文件。 该文件位于 <code>/public/home/elzd_2024_000125/DART/observations/obs_converters/AURA/work</code> 使用之前运行 <code>./quickbuild.sh</code> 进行编译。</p>
<p>然后修改<code>run_setup.sh</code> 修改相关信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@ year = 2012</span><br><span class="line">foreach month (12)</span><br><span class="line">foreach day (`seq 12 13`)  # 处理2012年12月12-13日的数据</span><br><span class="line">foreach second (00000 21600 43200 64800)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@ dayofyear = 335 + $day  # 提前算好2012-12-12日是一年中第几天</span><br><span class="line">        </span><br><span class="line"> set new_dayofyear = `printf &quot;%03d&quot; $dayofyear`</span><br><span class="line"> set new_month = `printf &quot;%02d&quot; $month` </span><br><span class="line"> set new_day = `printf &quot;%02d&quot; $day`</span><br><span class="line"> set new_second = `printf &quot;%05d&quot; $second`</span><br><span class="line"> set new_year = `printf &quot;%04d&quot; $year`</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"> sed -e &quot;s/DAYOFYEAR/$&#123;new_dayofyear&#125;/&quot; \</span><br><span class="line">     -e &quot;s/REPLACE_year/$&#123;new_year&#125;/&quot; \ </span><br><span class="line">     -e &quot;s/REPLACE_month/$&#123;new_month&#125;/&quot; \</span><br><span class="line">     -e &quot;s/REPLACE_day/$&#123;new_day&#125;/&quot; \</span><br><span class="line">     -e &quot;s/REPLACE_second/$&#123;new_second&#125;/&quot; \</span><br><span class="line">    inputDOY244.nml &gt; input.nml</span><br><span class="line"></span><br><span class="line"> ./convert_aura</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">@ dayofyear = <span class="variable">$dayofyear</span> + 1</span></span><br><span class="line"></span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同时修改该目录下的 <code>inputDOY244.nml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;convert_aura_nml</span><br><span class="line">  aura_netcdf_file = &#x27;/data2/share/elzd_2024_000125/xhw/downloadData/MLS/2013/Level2/DART_nc/201212_6H_CESM/REPLACE_year-REPLACE_month-REPLACE_day-REPLACE_second.nc&#x27;,</span><br><span class="line">  aura_netcdf_filelist = &#x27;&#x27;,</span><br><span class="line">  aura_outfile = &#x27;/data2/share/elzd_2024_000125/xhw/downloadData/MLS/2013/Level2/DART_seq/201212_6H_CESM/obs_seq.REPLACE_year-REPLACE_month-REPLACE_day-REPLACE_second&#x27;,</span><br><span class="line">  aura_yr = REPLACE_year,</span><br><span class="line">  aura_doy = DAYOFYEAR ,</span><br><span class="line"> /</span><br><span class="line">  </span><br><span class="line">&amp;obs_kind_nml</span><br><span class="line">   assimilate_these_obs_types = &#x27;AURAMLS_TEMPERATURE&#x27;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要注意的是，这个转换工具有个bug，就是如果当前的时间戳是2012-12-02-00000，这时</p>
<p>按理说应该以2号00000时为中心，左边三小时，右边三小时都放在一起方便同化。但是在识别左边三小时的数据时间戳时，会把1号识别成2号。从而在这个同化窗口内，数据值没错，但时间戳错了（1号写成了2号）。 这时需要修改 <code>DART/observations/obs_converters/AURA/convert_aura.f90</code> 由于我们在nc文件中提前写入了，当前数据值属于一年中的哪一天。所以我们就用这个信息控制时间戳。以下是<code>convert_aura.f90</code> 的脚本</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">! This code is not protected by the DART copyright agreement.</span></span><br><span class="line"><span class="comment">! DART $Id$</span></span><br><span class="line"></span><br><span class="line"><span class="comment">!     Nick Pedatella</span></span><br><span class="line"><span class="comment">!     Program to convert Aura Temperature data to DART Observation</span></span><br><span class="line"><span class="comment">!     sequence files. </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">program</span></span> convert_aura</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span>        types_mod, <span class="keyword">only</span> : r8</span><br><span class="line"><span class="keyword">use</span> time_manager_mod, <span class="keyword">only</span> : time_type, set_calendar_type, GREGORIAN, set_time,&amp;</span><br><span class="line">                             increment_time, get_time, set_date, operator(-),  &amp;</span><br><span class="line">                             print_date, operator(+)</span><br><span class="line"><span class="keyword">use</span>    utilities_mod, <span class="keyword">only</span> : initialize_utilities, find_namelist_in_file,    &amp;</span><br><span class="line">                             check_namelist_read, nmlfileunit, do_nml_file,    &amp;</span><br><span class="line">                             get_next_filename, error_handler, E_ERR, E_MSG, &amp;</span><br><span class="line">                             find_textfile_dims, finalize_utilities, &amp;</span><br><span class="line">                             timestamp,do_nml_term</span><br><span class="line"><span class="keyword">use</span>  netcdf_utilities_mod, <span class="keyword">only</span> : nc_check</span><br><span class="line"><span class="keyword">use</span>     location_mod, <span class="keyword">only</span> : VERTISPRESSURE, set_location <span class="comment">! pressure ccordinates for SABER</span></span><br><span class="line"><span class="keyword">use</span> obs_sequence_mod, <span class="keyword">only</span> : obs_sequence_type, obs_type, read_obs_seq,       &amp;</span><br><span class="line">                             static_init_obs_sequence, init_obs, destroy_obs, &amp;</span><br><span class="line">                             write_obs_seq, init_obs_sequence, get_num_obs,   &amp;</span><br><span class="line">                             insert_obs_in_seq, destroy_obs_sequence,         &amp;</span><br><span class="line">                             set_copy_meta_data, set_qc_meta_data, set_qc,    &amp; </span><br><span class="line">                             set_obs_values, set_obs_def, insert_obs_in_seq</span><br><span class="line"><span class="keyword">use</span> obs_def_mod,      <span class="keyword">only</span> : obs_def_type, set_obs_def_time, set_obs_def_type_of_obs, &amp;</span><br><span class="line">                             set_obs_def_error_variance, set_obs_def_location, &amp;</span><br><span class="line">                             set_obs_def_key</span><br><span class="line"><span class="keyword">use</span> obs_utilities_mod, <span class="keyword">only</span> : create_3d_obs,add_obs_to_seq</span><br><span class="line"><span class="keyword">use</span>     obs_kind_mod, <span class="keyword">only</span> : AURAMLS_TEMPERATURE</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span>           netcdf</span><br><span class="line"></span><br><span class="line"><span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! version controlled file description for error handling, do not edit</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">256</span>), <span class="keyword">parameter</span> :: source   = &amp;</span><br><span class="line">   <span class="string">&quot;$URL$&quot;</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">32</span> ), <span class="keyword">parameter</span> :: revision = <span class="string">&quot;$Revision$&quot;</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">128</span>), <span class="keyword">parameter</span> :: revdate  = <span class="string">&quot;$Date$&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">integer</span>, <span class="keyword">parameter</span> :: num_copies = <span class="number">1</span>,   &amp;   <span class="comment">! number of copies in sequence</span></span><br><span class="line">                      num_qc     = <span class="number">1</span>        <span class="comment">! number of QC entries</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! variables</span></span><br><span class="line"><span class="keyword">character</span> (len=<span class="number">130</span>) :: msgstring, next_infile</span><br><span class="line"><span class="keyword">character</span> (len=<span class="number">80</span>) :: <span class="keyword">name</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">integer</span> :: iyear,iday,imonth,idoy,ihr,imin,isec,nalt,nevent,ialt,ievent, &amp;</span><br><span class="line">           nfiles,ncid,varid,filenum,io,iunit,obs_num,num_new_obs,k,osec,oday</span><br><span class="line"><span class="keyword">logical</span> :: file_exist, first_obs, did_obs, from_list = .false.</span><br><span class="line"></span><br><span class="line"><span class="keyword">real</span>(r8) :: qc,oerr,pres_out</span><br><span class="line"></span><br><span class="line"><span class="keyword">real</span>(r8), <span class="keyword">allocatable</span> :: lat(:), lon(:), pres(:),temp(:,:),qual(:),conv(:),time(:), DAYOFYEAR(:), YEAR(:)</span><br><span class="line"><span class="keyword">real</span>(r8), <span class="keyword">allocatable</span> :: localsolartime(:)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span>(obs_def_type)      :: obs_def</span><br><span class="line"><span class="keyword">type</span>(obs_sequence_type) :: obs_seq</span><br><span class="line"><span class="keyword">type</span>(obs_type)          :: obs, prev_obs</span><br><span class="line"><span class="keyword">type</span>(time_type)         :: time_obs, time_anal, prev_time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">! namelist parameters</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">128</span>) :: aura_netcdf_file     = <span class="string">&#x27;aura_input.nc&#x27;</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">128</span>) :: aura_netcdf_filelist = <span class="string">&#x27;aura_input_list&#x27;</span></span><br><span class="line"><span class="keyword">character</span>(len=<span class="number">128</span>) :: aura_outfile        = <span class="string">&#x27;obs_seq.aura&#x27;</span></span><br><span class="line"><span class="keyword">integer</span> :: aura_yr=<span class="number">2011</span>,aura_doy = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namelist</span> /convert_aura_nml/ aura_netcdf_file, aura_netcdf_filelist, &amp;</span><br><span class="line">                             aura_outfile,aura_yr,aura_doy</span><br><span class="line"></span><br><span class="line"><span class="comment">! initialize some values</span></span><br><span class="line">obs_num = <span class="number">1</span></span><br><span class="line">qc = <span class="number">1.0_r8</span></span><br><span class="line">first_obs = .true.</span><br><span class="line"><span class="keyword">call</span> set_calendar_type(GREGORIAN)</span><br><span class="line"></span><br><span class="line"><span class="comment">!  read the necessary parameters from input.nml</span></span><br><span class="line"><span class="keyword">call</span> initialize_utilities()</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> find_namelist_in_file(<span class="string">&quot;input.nml&quot;</span>, <span class="string">&quot;convert_aura_nml&quot;</span>, iunit)</span><br><span class="line">read(iunit, <span class="keyword">nml</span> = convert_aura_nml, <span class="keyword">iostat</span> = io)</span><br><span class="line"><span class="keyword">call</span> check_namelist_read(iunit, io, <span class="string">&quot;convert_aura_nml&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">! Record the namelist values used for the run </span></span><br><span class="line"><span class="keyword">if</span> (do_nml_file()) <span class="built_in">write</span>(nmlfileunit, <span class="keyword">nml</span>=convert_aura_nml)</span><br><span class="line"><span class="keyword">if</span> (do_nml_term()) <span class="built_in">write</span>(     *     , <span class="keyword">nml</span>=convert_aura_nml)</span><br><span class="line"></span><br><span class="line"><span class="comment">! namelist checks for sanity</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! cannot have both a single filename and a list; the namelist must</span></span><br><span class="line"><span class="comment">! shut one off.</span></span><br><span class="line"><span class="keyword">if</span> (aura_netcdf_file /= <span class="string">&#x27;&#x27;</span> .and. aura_netcdf_filelist /= <span class="string">&#x27;&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">call</span> error_handler(E_ERR, <span class="string">&#x27;convert_aura_cdf&#x27;</span>,                     &amp;</span><br><span class="line">                     <span class="string">&#x27;One of aura_netcdf_file or filelist must be NULL&#x27;</span>, &amp;</span><br><span class="line">                     source, revision, revdate)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">if</span> (aura_netcdf_filelist /= <span class="string">&#x27;&#x27;</span>) from_list = .true.</span><br><span class="line"></span><br><span class="line"><span class="comment">! Define Number of observations:</span></span><br><span class="line"><span class="keyword">if</span> (from_list) <span class="keyword">then</span></span><br><span class="line">  num_new_obs = (<span class="number">400</span> * <span class="number">40000</span>) * nfiles</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  num_new_obs = (<span class="number">400</span> * <span class="number">40000</span> )</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! output date</span></span><br><span class="line"><span class="built_in">print</span> *, <span class="string">&#x27;OUTPUTING FOR YR=&#x27;</span>,aura_yr,<span class="string">&#x27;DOY=&#x27;</span>,aura_doy</span><br><span class="line"></span><br><span class="line"><span class="comment">!  either read existing obs_seq or create a new one</span></span><br><span class="line"><span class="keyword">call</span> static_init_obs_sequence()</span><br><span class="line"><span class="keyword">call</span> init_obs(obs, num_copies, num_qc)</span><br><span class="line"><span class="keyword">call</span> init_obs(prev_obs, num_copies, num_qc)</span><br><span class="line">inquire(<span class="keyword">file</span>=aura_outfile, <span class="keyword">exist</span>=file_exist)</span><br><span class="line"><span class="keyword">if</span> ( file_exist ) <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">print</span> *, <span class="string">&quot;found existing obs_seq file, overwriting &quot;</span>, <span class="built_in">trim</span>(aura_outfile)</span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">&quot;max entries = &quot;</span>, num_new_obs</span><br><span class="line">  <span class="keyword">call</span> init_obs_sequence(obs_seq, num_copies, num_qc, num_new_obs)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> k = <span class="number">1</span>, num_copies</span><br><span class="line">    <span class="keyword">call</span> set_copy_meta_data(obs_seq, k, <span class="string">&#x27;observation&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">do</span> k = <span class="number">1</span>, num_qc</span><br><span class="line">    <span class="keyword">call</span> set_qc_meta_data(obs_seq, k, <span class="string">&#x27;Data QC&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">&quot;no existing obs_seq file, creating &quot;</span>, <span class="built_in">trim</span>(aura_outfile)</span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">&quot;max entries = &quot;</span>, num_new_obs</span><br><span class="line">  <span class="keyword">call</span> init_obs_sequence(obs_seq, num_copies, num_qc, num_new_obs)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> k = <span class="number">1</span>, num_copies</span><br><span class="line">    <span class="keyword">call</span> set_copy_meta_data(obs_seq, k, <span class="string">&#x27;observation&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">do</span> k = <span class="number">1</span>, num_qc</span><br><span class="line">    <span class="keyword">call</span> set_qc_meta_data(obs_seq, k, <span class="string">&#x27;Data QC&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">did_obs = .false.</span><br><span class="line"><span class="comment">! main loop that does either a single file or a list of files</span></span><br><span class="line"></span><br><span class="line">filenum = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">fileloop: <span class="keyword">do</span>  <span class="comment">! until out of files</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">! get the single name, or the next name from a list</span></span><br><span class="line">   <span class="keyword">if</span> (from_list) <span class="keyword">then</span> </span><br><span class="line">      next_infile = get_next_filename(aura_netcdf_filelist, filenum)</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      next_infile = aura_netcdf_file</span><br><span class="line">      <span class="keyword">if</span> (filenum &gt; <span class="number">1</span>) next_infile = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   <span class="keyword">endif</span></span><br><span class="line">   <span class="keyword">if</span> (next_infile == <span class="string">&#x27;&#x27;</span>) <span class="keyword">exit</span> fileloop</span><br><span class="line"></span><br><span class="line">   <span class="comment">! open the file</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_open(next_infile, nf90_nowrite, ncid), <span class="string">&#x27;file open&#x27;</span>, next_infile)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! get the number of events and altitude:</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_dimid(ncid,<span class="string">&quot;levels&quot;</span>,varid), <span class="string">&#x27;inq dimid altitude&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inquire_dimension(ncid,varid,<span class="keyword">name</span>,nalt), <span class="string">&#x27;inq dim altitude&#x27;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_dimid(ncid,<span class="string">&quot;times&quot;</span>,varid), <span class="string">&#x27;inq dimid event&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inquire_dimension(ncid,varid,<span class="keyword">name</span>,nevent), <span class="string">&#x27;inq dim event&#x27;</span>)</span><br><span class="line">   <span class="built_in">print</span> *, <span class="string">&#x27;nalt=&#x27;</span>,nalt</span><br><span class="line">   <span class="built_in">allocate</span>( time(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( lat(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( lon(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( pres(nalt) )</span><br><span class="line">   <span class="built_in">allocate</span>( temp(nalt,nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( qual(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( conv(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( localsolartime(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( DAYOFYEAR(nevent) )</span><br><span class="line">   <span class="built_in">allocate</span>( YEAR(nevent) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">! read in the latitude array</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Latitude&quot;</span>, varid) ,<span class="string">&#x27;inq varid Lat&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, lat)     ,<span class="string">&#x27;get var   Lat&#x27;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the longitude array</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Longitude&quot;</span>, varid) ,<span class="string">&#x27;inq varid Lon&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, lon)     ,<span class="string">&#x27;get var   Lon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the altitude array</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Pressure&quot;</span>, varid) ,<span class="string">&#x27;inq varid pressure&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, pres)        ,<span class="string">&#x27;get_var   pressure&#x27;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the temperature</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Temperature&quot;</span>, varid) ,<span class="string">&#x27;inq varid ktemp&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, temp)        ,<span class="string">&#x27;get_var   ktemp&#x27;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="comment">! quality</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Quality&quot;</span>, varid) ,<span class="string">&#x27;inq varid quality&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, qual)        ,<span class="string">&#x27;get_var   quality&#x27;</span>)</span><br><span class="line">   <span class="comment">! convergence</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Convergence&quot;</span>, varid) ,<span class="string">&#x27;inq varid conv&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, conv)        ,<span class="string">&#x27;get_var   conv&#x27;</span>)</span><br><span class="line">   <span class="comment">! LST</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;LocalSolarTime&quot;</span>, varid) ,<span class="string">&#x27;inq varid lst&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, localsolartime)        ,<span class="string">&#x27;get_var   lst&#x27;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the date/time</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;Time&quot;</span>, varid) ,<span class="string">&#x27;inq varid time&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, time)        ,<span class="string">&#x27;get_var   time&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the date/time</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;DAYOFYEAR&quot;</span>, varid) ,<span class="string">&#x27;inq varid DAYOFYEAR&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, DAYOFYEAR)        ,<span class="string">&#x27;get_var DAYOFYEAR&#x27;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! read the date/time</span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_inq_varid(ncid, <span class="string">&quot;YEAR&quot;</span>, varid) ,<span class="string">&#x27;inq varid YEAR&#x27;</span>)</span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_get_var(ncid, varid, YEAR)        ,<span class="string">&#x27;get_var YEAR&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="comment">! finished reading the data </span></span><br><span class="line">   <span class="keyword">call</span> nc_check( nf90_close(ncid), <span class="string">&#x27;close file&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">! now loop through each event / altitude and add to obs sequence file</span></span><br><span class="line">   <span class="keyword">do</span> ievent=<span class="number">1</span>,nevent</span><br><span class="line"></span><br><span class="line">     <span class="keyword">do</span> ialt=<span class="number">1</span>,nalt</span><br><span class="line"></span><br><span class="line">       <span class="comment">!calculate seconds from LST</span></span><br><span class="line">       isec = <span class="built_in">int</span>( (localsolartime(ievent)-(lon(ievent)/<span class="number">15.</span>))/<span class="number">24.</span>*<span class="number">86400.</span> )</span><br><span class="line">       <span class="keyword">if</span> (isec.le<span class="number">.0</span>) isec = isec + <span class="number">86400</span>       </span><br><span class="line">       <span class="keyword">if</span> (isec.ge<span class="number">.86400</span>) isec = isec - <span class="number">86400</span>       </span><br><span class="line"></span><br><span class="line">       <span class="comment">! iyear = aura_yr ! yr &amp; day are inputs</span></span><br><span class="line">       <span class="comment">! idoy = aura_doy</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">! edited by xhw </span></span><br><span class="line">       iyear = YEAR(ievent) <span class="comment">! yr &amp; day are inputs</span></span><br><span class="line">       idoy = DAYOFYEAR(ievent)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">       <span class="keyword">call</span> convert_day(iyear,idoy,imonth,iday)</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (temp(ialt,ievent).ne.-<span class="number">999.</span> .and. &amp; <span class="comment">! data is missing</span></span><br><span class="line">           qual(ievent).ge<span class="number">.0</span><span class="number">.65</span> .and. &amp; <span class="comment">!specified quality check</span></span><br><span class="line">           conv(ievent).le<span class="number">.1</span><span class="number">.2</span> .and. &amp; <span class="comment">! specified convergence</span></span><br><span class="line">           pres(ialt).ge<span class="number">.0</span><span class="number">.001</span> .and. pres(ialt).le<span class="number">.260</span> .and. &amp; <span class="comment">!good altitude range</span></span><br><span class="line">           isec .lt<span class="number">.86400</span> ) <span class="keyword">then</span> </span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">         ihr = <span class="built_in">int</span>( isec / <span class="number">3600</span> )</span><br><span class="line">         imin = <span class="built_in">int</span>( (isec-ihr*<span class="number">3600</span>) / <span class="number">60</span> )</span><br><span class="line">         isec = <span class="built_in">int</span>( (isec-ihr*<span class="number">3600</span>)-imin*<span class="number">60</span> )</span><br><span class="line">         time_obs = set_date(iyear,imonth,iday,ihr,imin,isec)</span><br><span class="line">         <span class="keyword">call</span> get_time(time_obs,osec,oday)</span><br><span class="line"></span><br><span class="line">         <span class="comment">! need to set the error (for now just take SABER error):</span></span><br><span class="line">         <span class="keyword">call</span> saber_error(pres(ialt),oerr)</span><br><span class="line"></span><br><span class="line">         <span class="comment">! convert pressure from mbar(hPa) -&gt; Pa</span></span><br><span class="line">         pres_out = pres(ialt)*<span class="number">100.</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (lon(ievent).le<span class="number">.0</span>) lon(ievent) = lon(ievent)+<span class="number">360.</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">! now creat the observation:</span></span><br><span class="line">         <span class="keyword">call</span> create_3d_obs(lat(ievent),lon(ievent),pres_out, &amp;</span><br><span class="line">                            VERTISPRESSURE,temp(ialt,ievent), &amp;</span><br><span class="line">                          AURAMLS_TEMPERATURE,oerr,oday,osec,qc,obs)</span><br><span class="line">         <span class="keyword">call</span> add_obs_to_seq(obs_seq,obs,time_obs,prev_obs,prev_time,first_obs)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span>(.not. did_obs) did_obs = .true.</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line">     <span class="keyword">end</span> <span class="keyword">do</span> <span class="comment">! end alt loop</span></span><br><span class="line">   <span class="keyword">end</span> <span class="keyword">do</span> <span class="comment">! end event loop</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">! clean up and loop if there is another input file</span></span><br><span class="line">   <span class="built_in">deallocate</span>( lat,lon,pres,qual,conv,time,temp)</span><br><span class="line"> </span><br><span class="line">   filenum = filenum + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">do</span> fileloop</span><br><span class="line"></span><br><span class="line"><span class="comment">! done with main loop. if we added any obs to the sequence, write it out:</span></span><br><span class="line"><span class="keyword">if</span> (did_obs) <span class="keyword">then</span></span><br><span class="line"><span class="comment">!print *, &#x27;ready to write, nobs = &#x27;, get_num_obs(obs_seq)</span></span><br><span class="line">   <span class="keyword">if</span> (get_num_obs(obs_seq) &gt; <span class="number">0</span>) &amp;</span><br><span class="line">      <span class="keyword">call</span> write_obs_seq(obs_seq, aura_outfile)</span><br><span class="line"></span><br><span class="line">   <span class="comment">! minor stab at cleanup, in the off chance this will someday get turned</span></span><br><span class="line">   <span class="comment">! into a subroutine in a module.  probably not all that needs to be done,</span></span><br><span class="line">   <span class="comment">! but a start.</span></span><br><span class="line">   <span class="keyword">call</span> destroy_obs(obs)</span><br><span class="line"><span class="comment">! if obs == prev_obs then you can&#x27;t delete the same obs twice.</span></span><br><span class="line"><span class="comment">! buf if they differ, then it&#x27;s a leak.  for now, don&#x27;t delete prev</span></span><br><span class="line"><span class="comment">! since the program is exiting here anyway.</span></span><br><span class="line">   <span class="comment">!call destroy_obs(prev_obs)</span></span><br><span class="line">   <span class="keyword">if</span> (get_num_obs(obs_seq) &gt; <span class="number">0</span>) <span class="keyword">call</span> destroy_obs_sequence(obs_seq)</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">! END OF MAIN ROUTINE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">contains</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">subroutine</span></span> convert_day(iyear,idoy,imonth,iday)</span><br><span class="line"><span class="comment">! NMP - Subroutine to convert from yr,doy to yr,mon,day</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>)   :: iyear</span><br><span class="line"> <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>)   :: idoy</span><br><span class="line"> <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">out</span>)  :: imonth</span><br><span class="line"> <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">out</span>)  :: iday</span><br><span class="line"></span><br><span class="line"> <span class="keyword">integer</span> :: t</span><br><span class="line"></span><br><span class="line"> t = <span class="number">0</span></span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">modulo</span>(iyear, <span class="number">4</span>) == <span class="number">0</span>) t = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(<span class="built_in">modulo</span>(iyear, <span class="number">400</span>) /= <span class="number">0</span> .and. <span class="built_in">modulo</span>(iyear, <span class="number">100</span>) == <span class="number">0</span>) t = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> iday = idoy</span><br><span class="line"> <span class="keyword">if</span>(idoy &gt; <span class="number">59</span>+t) iday = iday + <span class="number">2</span> - t</span><br><span class="line"> imonth = ((iday+<span class="number">91</span>)*<span class="number">100</span>)/<span class="number">3055</span></span><br><span class="line"> iday = (iday+<span class="number">91</span>) - (imonth*<span class="number">3055</span>)/<span class="number">100</span></span><br><span class="line"> imonth = imonth - <span class="number">2</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(imonth &gt;= <span class="number">1</span> .and. imonth &lt;= <span class="number">12</span>) <span class="keyword">return</span></span><br><span class="line"> <span class="built_in">write</span>(<span class="keyword">unit</span>=*,<span class="keyword">fmt</span>=<span class="string">&quot;(a,i11,a)&quot;</span>)  &amp;</span><br><span class="line"> <span class="string">&quot;$$CALEND: DAY OF THE YEAR INPUT =&quot;</span>,idoy,<span class="string">&quot; IS OUT OF RANGE.&quot;</span></span><br><span class="line"> <span class="keyword">stop</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">subroutine</span></span> saber_error(pres,err)</span><br><span class="line"></span><br><span class="line"><span class="keyword">real</span>(r8), <span class="keyword">intent</span>(<span class="keyword">in</span>)  :: pres</span><br><span class="line"><span class="keyword">real</span>(r8), <span class="keyword">intent</span>(<span class="keyword">out</span>) :: err</span><br><span class="line"></span><br><span class="line"><span class="comment">! NMP - simple function to calculate the error based on height</span></span><br><span class="line"><span class="comment">!  function loosely based on Remsberg et al (2008JGR)</span></span><br><span class="line"></span><br><span class="line">err = <span class="number">1.6718_r8</span> - <span class="number">0.4281_r8</span>*<span class="built_in">log</span>(pres) + <span class="number">0.0977_r8</span>*<span class="built_in">log</span>(pres)**<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">program</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">! &lt;next few lines under version control, do not edit&gt;</span></span><br><span class="line"><span class="comment">! $URL$</span></span><br><span class="line"><span class="comment">! $Id$</span></span><br><span class="line"><span class="comment">! $Revision$</span></span><br><span class="line"><span class="comment">! $Date$</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>修改完成后需要重新编译, <code>quickbuild.sh</code> 但是由于运行<code>run_setup.sh</code> 会覆盖编译使用的<code>input.nml</code> 。 我们可以从官网再单独下载一下放到目录下<a target="_blank" rel="noopener" href="https://github.com/NCAR/DART/blob/main/observations/obs_converters/AURA/work/input.nml">DART/observations/obs_converters/AURA/work/input.nml at main · NCAR/DART (github.com)</a>，然后<code>quickbuild.sh</code></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://example.com">XHW</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2024/07/27/DART/">http://example.com/2024/07/27/DART/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/%E8%BD%AF%E4%BB%B6/">软件</a></div><div class="post_share"><div class="social-share" data-image="/img/cover22.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/22/Color/"><img class="prev-cover" src="/img/category.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">作图颜色选取</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/09/barotroicalModel/"><img class="next-cover" src="/img/category.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">barotroicalModel</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/03/21/CESM/" title="CESM的安装及运行"><img class="cover" src="/img/cover20.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-21</div><div class="title">CESM的安装及运行</div></div></a></div><div><a href="/2023/12/29/LBM/" title="LBM 安装-运行-修改-debug"><img class="cover" src="/img/cover18.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-29</div><div class="title">LBM 安装-运行-修改-debug</div></div></a></div><div><a href="/2024/04/24/computeNode/" title="VsCode连接到集群的计算节点"><img class="cover" src="/img/cover01.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">VsCode连接到集群的计算节点</div></div></a></div><div><a href="/2022/07/11/linux/" title="Linux 操作"><img class="cover" src="/img/cover7.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-11</div><div class="title">Linux 操作</div></div></a></div><div><a href="/2023/09/04/SomeSoftwares/" title="一些装机软件"><img class="cover" src="/img/cover15.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-04</div><div class="title">一些装机软件</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/maomi.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">XHW</div><div class="author-info__description">甚矣，汝之不惠</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-2"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DART-config"><span class="toc-number">2.</span> <span class="toc-text">DART_config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#input-nml"><span class="toc-number">3.</span> <span class="toc-text">input.nml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#assimilation-csh"><span class="toc-number">4.</span> <span class="toc-text">assimilation.csh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#compress-csh"><span class="toc-number">5.</span> <span class="toc-text">compress.csh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EFWSD%E5%92%8CFWHIST"><span class="toc-number">6.</span> <span class="toc-text">关于FWSD和FWHIST</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%82%E6%B5%8B%E6%95%B0%E6%8D%AE"><span class="toc-number">7.</span> <span class="toc-text">观测数据</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/22/Color/" title="作图颜色选取"><img src="/img/category.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="作图颜色选取"/></a><div class="content"><a class="title" href="/2024/10/22/Color/" title="作图颜色选取">作图颜色选取</a><time datetime="2024-10-22T07:15:17.000Z" title="Created 2024-10-22 15:15:17">2024-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/27/DART/" title="DART学习"><img src="/img/cover22.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DART学习"/></a><div class="content"><a class="title" href="/2024/07/27/DART/" title="DART学习">DART学习</a><time datetime="2024-07-27T06:43:02.000Z" title="Created 2024-07-27 14:43:02">2024-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/09/barotroicalModel/" title="barotroicalModel"><img src="/img/category.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="barotroicalModel"/></a><div class="content"><a class="title" href="/2024/06/09/barotroicalModel/" title="barotroicalModel">barotroicalModel</a><time datetime="2024-06-09T06:43:02.000Z" title="Created 2024-06-09 14:43:02">2024-06-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/30/vscodeNotebook/" title="VsCode使用jupyter时附加交互窗口"><img src="/img/cover21.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="VsCode使用jupyter时附加交互窗口"/></a><div class="content"><a class="title" href="/2024/04/30/vscodeNotebook/" title="VsCode使用jupyter时附加交互窗口">VsCode使用jupyter时附加交互窗口</a><time datetime="2024-04-30T10:26:48.000Z" title="Created 2024-04-30 18:26:48">2024-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/24/computeNode/" title="VsCode连接到集群的计算节点"><img src="/img/cover01.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="VsCode连接到集群的计算节点"/></a><div class="content"><a class="title" href="/2024/04/24/computeNode/" title="VsCode连接到集群的计算节点">VsCode连接到集群的计算节点</a><time datetime="2024-04-24T13:50:17.000Z" title="Created 2024-04-24 21:50:17">2024-04-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/tianqizhizi.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By XHW</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox.umd.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('/pluginsSrc/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = '/pluginsSrc/mathjax/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>